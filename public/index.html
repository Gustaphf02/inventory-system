<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js" rel="preload">
    <style>
        .modal.show {
            display: block !important;
        }
        
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        
        #addProductModal {
            z-index: 1055;
        }
        
        #addProductModal.show {
            display: block !important;
        }
        
        #editProductModal {
            z-index: 1055;
        }
        
        #editProductModal.show {
            display: block !important;
        }
        
        #addExistingEquipmentModal {
            z-index: 1055;
        }
        
        #addExistingEquipmentModal.show {
            display: block !important;
        }
        
        #addSiteModal {
            z-index: 1055;
        }
        
        #addSiteModal.show {
            display: block !important;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }
        
        /* Estilos para dropdown items */
        .sidebar .dropdown-menu {
            background-color: #1a1a1a;
            border: 1px solid #FFD700;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar .dropdown-item {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
            padding: 8px 16px;
        }
        
        .sidebar .dropdown-item:hover {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
        }
        
        .sidebar .dropdown-item.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: box-shadow 0.15s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .stat-card {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: #000;
        }
        .stat-card .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Colores pastel y hover para filas de tabla */
        .table tbody tr {
            background-color: #fff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .table tbody tr:nth-child(even) {
            background-color: #f5f7fa;
        }
        
        .table tbody tr:nth-child(even):hover {
            background-color: #e8ebef;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            border: none;
            color: #000;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #B8860B 0%, #8B6914 100%);
            color: #fff;
        }
        .search-box {
            position: relative;
        }
        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .badge-status {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .navbar-brand {
            color: #FFD700 !important;
        }
        .btn-outline-light:hover {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #000;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
        }
        .badge.bg-success {
            background-color: #28a745 !important;
        }
        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        .badge.bg-danger {
            background-color: #dc3545 !important;
        }
        .btn-outline-primary {
            color: #FFD700;
            border-color: #FFD700;
        }
        .btn-outline-primary:hover {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #000;
        }
        .btn-outline-info {
            color: #6c757d;
            border-color: #6c757d;
        }
        .btn-outline-info:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }
        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-danger:hover {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                    <div class="position-sticky pt-3">
                        <div class="text-center mb-4">
                            <h4 class="text-white">
                                <i class="fas fa-warehouse me-2"></i>
                                Inventario
                            </h4>
                        </div>
                        
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'dashboard'}" @click="setView('dashboard')">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'inventory'}" @click="setView('inventory')">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Inventario
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'sites'}" @click="setView('sites')">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Sitios
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" @click="setView('products'); setProductFilter('all')">
                                    <i class="fas fa-boxes me-2"></i>
                                    Productos
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" :class="{active: currentView === 'products' && productFilter === 'telecomunicacion'}" @click="setView('products'); setProductFilter('telecomunicacion')">
                                            <i class="fas fa-broadcast-tower me-2"></i>
                                            Equipo de telecomunicación
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" :class="{active: currentView === 'products' && productFilter === 'computo'}" @click="setView('products'); setProductFilter('computo')">
                                            <i class="fas fa-desktop me-2"></i>
                                            Equipos de cómputo
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" :class="{active: currentView === 'existing-equipment'}" @click="setView('existing-equipment')">
                                            <i class="fas fa-server me-2"></i>
                                            Equipos existentes
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'categories'}" @click="setView('categories')">
                                    <i class="fas fa-tags me-2"></i>
                                    Categorías
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'suppliers'}" @click="setView('suppliers')">
                                    <i class="fas fa-truck me-2"></i>
                                    Proveedores
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'reports'}" @click="setView('reports')">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Reportes
                                </a>
                            </li>
                            <!-- Navegación a páginas PHP reales en Render (visibles según rol) -->
                            <li class="nav-item" v-if="['admin','manager'].includes(user.role)">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('config.php')">
                                    <i class="fas fa-cog me-2"></i>
                                    Configuración
                                </a>
                            </li>
                            <li class="nav-item" v-if="user.role==='admin'">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('users.php')">
                                    <i class="fas fa-users me-2"></i>
                                    Usuarios
                                </a>
                            </li>
                            <li class="nav-item" v-if="['admin','manager'].includes(user.role)">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('maintenance.php')">
                                    <i class="fas fa-tools me-2"></i>
                                    Mantenimiento
                                </a>
                            </li>
                        </ul>
                        
                        <hr class="text-white">
                        
                        <div class="text-center">
                            <small class="text-white-50">
                                <span v-if="user && user.role !== 'guest'">
                                Usuario: {{ user.name }} ({{ user.role }})<br>
                                <a href="/logout.php" class="btn btn-sm btn-outline-light mt-2">
                                    <i class="fas fa-sign-out-alt me-1"></i>
                                    Cerrar Sesión
                                </a>
                                </span>
                                <span v-else>
                                    No Autenticado<br>
                                    <a href="/login.php" class="btn btn-sm btn-outline-light mt-2" @click.prevent="goToLogin">
                                        <i class="fas fa-sign-in-alt me-1"></i>
                                        Iniciar Sesión
                                    </a>
                                </span>
                            </small>
                        </div>
                    </div>
                </nav>

                <!-- Main content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">{{ getPageTitle() }}</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" @click="refreshData">
                                    <i class="fas fa-sync-alt"></i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard View -->
                    <div v-if="currentView === 'dashboard'">
                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Total Productos
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ inventorySummary.total_products || 0 }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-boxes stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Valor Total
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">${{ formatNumber(inventorySummary.total_value || 0) }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-dollar-sign stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Stock Bajo
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ inventorySummary.low_stock_products ? inventorySummary.low_stock_products.length : 0 }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Proveedores
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ suppliers.length }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-truck stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Products -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-boxes me-2"></i>
                                            Productos Recientes
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div v-if="loading" class="text-center py-5">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="mt-2">Cargando...</p>
                                        </div>
                                        <div v-else-if="recentProducts.length === 0" class="text-center py-5 text-muted">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>No hay productos recientes.</p>
                                        </div>
                                        <div v-else class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>SKU</th>
                                                        <th>Nombre</th>
                                                        <th>Stock</th>
                                                        <th>Precio</th>
                                                        <th>Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="product in recentProducts" :key="product.id">
                                                        <td>
                                                            <code>{{ product.sku }}</code>
                                                        </td>
                                                        <td>{{ product.name }}</td>
                                                        <td>
                                                            <span class="badge" :class="getStockBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                                {{ product.stock_quantity }}
                                                            </span>
                                                        </td>
                                                        <td>${{ formatNumber(product.price) }}</td>
                                                        <td>
                                                            <span class="badge badge-status" :class="getStatusBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                                {{ getStatusText(product.stock_quantity, product.min_stock_level) }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Stock Bajo
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div v-if="lowStockProducts.length === 0" class="text-center text-muted">
                                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                                            <p>¡Excelente! No hay productos con stock bajo.</p>
                                        </div>
                                        <div v-else>
                                            <div v-for="product in lowStockProducts" :key="product.id" class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <strong>{{ product.name }}</strong><br>
                                                    <small class="text-muted">{{ product.sku }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-danger">{{ product.stock_quantity }}</span><br>
                                                    <small class="text-muted">Mín: {{ product.min_stock_level }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory View -->
                    <div v-if="currentView === 'inventory'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Gestión de Inventario
                                </h5>
                                <div class="d-flex gap-2 mt-2 mt-md-0">
                                    <button class="btn btn-outline-secondary" @click="refreshInventory">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        Actualizar
                                    </button>
                                    <button class="btn btn-outline-primary" @click="searchInventory">
                                        <i class="fas fa-search me-1"></i>
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filtros de búsqueda -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por Categoría:</label>
                                        <select class="form-select" v-model="inventoryFilters.category" @change="filterInventory">
                                            <option value="">Todas las categorías</option>
                                            <option v-for="category in categories" :key="category.id" :value="category.name">{{ category.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por Ubicación:</label>
                                        <select class="form-select" v-model="inventoryFilters.location" @change="filterInventory">
                                            <option value="">Todas las ubicaciones</option>
                                            <option v-for="location in locations" :key="location.id" :value="location.name">{{ location.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar Producto:</label>
                                        <input type="text" class="form-control" v-model="inventoryFilters.search" @input="filterInventory" placeholder="SKU, nombre, serial...">
                                    </div>
                                </div>

                                <!-- Resumen del Inventario -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.total_products || 0 }}</h3>
                                                <p class="mb-0">Total Productos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h3>${{ (inventorySummary.total_value || 0).toFixed(2) }}</h3>
                                                <p class="mb-0">Valor Total</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.low_stock_products?.length || 0 }}</h3>
                                                <p class="mb-0">Stock Bajo</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.unique_departments_count || 0 }}</h3>
                                                <p class="mb-0">Departamentos</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Inventario -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serial</th>
                                                <th>Marbete</th>
                                                <th>Tipo</th>
                                                <th>Categoría</th>
                                                <th>Proveedor</th>
                                                <th>Departamento</th>
                                                <th>Stock</th>
                                                <th>Precio</th>
                                                <th>Valor Total</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredInventory" :key="product.id">
                                                <td><code>{{ product.sku }}</code></td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td><small>{{ product.description || 'Sin descripción' }}</small></td>
                                                <td><strong>{{ product.brand || 'Sin marca' }}</strong></td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number }}</small></td>
                                                <td><code>{{ product.label }}</code></td>
                                                <td><span class="badge" :class="product.type === 'telecomunicacion' ? 'bg-primary' : 'bg-success'">{{ product.type === 'telecomunicacion' ? 'Telecomunicación' : 'Cómputo' }}</span></td>
                                                <td><span class="badge bg-secondary">{{ product.category_name }}</span></td>
                                                <td><span class="badge bg-info">{{ product.supplier_name }}</span></td>
                                                <td><span class="badge bg-warning">{{ product.department || 'Sin asignar' }}</span></td>
                                                <td>
                                                    <span class="badge" :class="product.stock_quantity <= product.min_stock_level ? 'bg-danger' : 'bg-success'">
                                                        {{ product.stock_quantity }}
                                                    </span>
                                                </td>
                                                <td>${{ (parseFloat(product.price) || 0).toFixed(2) }}</td>
                                                <td>${{ (parseFloat(product.stock_quantity) * parseFloat(product.price) || 0).toFixed(2) }}</td>
                                                <td>
                                                    <span class="badge" :class="product.status === 'active' ? 'bg-success' : 'bg-secondary'">
                                                        {{ product.status === 'active' ? 'Activo' : 'Inactivo' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                         <button class="btn btn-outline-primary" @click="editProduct(product)" title="Editar producto">
                                                              <i class="fas fa-edit"></i>
                                                          </button>
                                                         <button class="btn btn-outline-danger" @click="deleteProduct(product.id)" title="Eliminar producto">
                                                              <i class="fas fa-trash"></i>
                                                          </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products View -->
                    <div v-if="currentView === 'products'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-boxes me-2"></i>
                                    Gestión de Productos
                                </h5>
                                <button class="btn btn-primary mt-2 mt-md-0" onclick="openModal()">
                                    <i class="fas fa-plus me-1"></i>
                                    Agregar Producto
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filters -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="search-box">
                                            <input type="text" class="form-control" placeholder="Buscar productos..." v-model="searchQuery" @input="searchProducts">
                                            <i class="fas fa-search search-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" v-model="selectedCategory" @change="filterProducts">
                                            <option value="">Todas las categorías</option>
                                            <option v-for="category in categories" :key="category.id" :value="category.id">
                                                {{ category.name }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" v-model="selectedSupplier" @change="filterProducts">
                                            <option value="">Todos los proveedores</option>
                                            <option v-for="supplier in suppliers" :key="supplier.id" :value="supplier.id">
                                                {{ supplier.name }}
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Products Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serial</th>
                                                <th>Marbete</th>
                                                <th>Tipo</th>
                                                <th>Categoría</th>
                                                <th>Proveedor</th>
                                                <th>Departamento</th>
                                                <th>Stock</th>
                                                <th>Precio</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredProducts" :key="product.id">
                                                <td>
                                                    <code>{{ product.sku }}</code>
                                                </td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td><small>{{ product.description || 'Sin descripción' }}</small></td>
                                                <td><strong>{{ product.brand || 'Sin marca' }}</strong></td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number }}</small></td>
                                                <td><code>{{ product.label }}</code></td>
                                                <td><span class="badge" :class="product.type === 'telecomunicacion' ? 'bg-primary' : 'bg-success'">{{ product.type === 'telecomunicacion' ? 'Telecomunicación' : 'Cómputo' }}</span></td>
                                                <td><span class="badge bg-secondary">{{ product.category_name || 'Sin categoría' }}</span></td>
                                                <td><span class="badge bg-info">{{ product.supplier_name || 'Sin proveedor' }}</span></td>
                                                <td>
                                                    <span class="badge bg-warning text-dark">
                                                        {{ product.department || 'Sin asignar' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge" :class="getStockBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                        {{ product.stock_quantity }}
                                                    </span>
                                                </td>
                                                <td>${{ formatNumber(product.price) }}</td>
                                                <td>
                                                    <span class="badge" :class="product.status === 'active' ? 'bg-success' : product.status === 'maintenance' ? 'bg-warning text-dark' : 'bg-secondary'">
                                                        {{ product.status === 'active' ? 'Activo' : product.status === 'maintenance' ? 'Mantenimiento' : 'Inactivo' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" @click="editProduct(product.id)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-info" @click="viewProduct(product.id)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" @click="deleteProduct(product.id)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Equipment View -->
                    <div v-if="currentView === 'existing-equipment'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-server me-2"></i>
                                    Equipos existentes
                                </h5>
                                <button class="btn btn-primary mt-2 mt-md-0" onclick="openModalForExistingEquipment()">
                                    <i class="fas fa-plus me-1"></i>
                                    Agregar Producto
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Filtros y Exportar -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="filterDepartment" class="form-label">Filtrar por Departamento</label>
                                        <select class="form-select" id="filterDepartment" v-model="existingEquipmentFilters.department" @change="filterExistingEquipment">
                                            <option value="">Todos los departamentos</option>
                                            <option v-for="dept in uniqueDepartments" :key="dept" :value="dept">
                                                {{ dept }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="filterNumericAssign" class="form-label">Filtrar por Asig. Numérica</label>
                                        <input type="text" class="form-control" id="filterNumericAssign" 
                                               v-model="existingEquipmentFilters.numericAssign" 
                                               @input="filterExistingEquipment"
                                               placeholder="Buscar por Asig. Numérica...">
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button class="btn btn-success w-100" @click="exportExistingEquipmentToExcel">
                                            <i class="fas fa-file-excel me-2"></i>
                                            Exportar a Excel
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tabla de Equipos Existentes -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serie</th>
                                                <th>Departamento</th>
                                                <th>Cantidad</th>
                                                <th>Especificaciones/EXT</th>
                                                <th>Sub-Especific</th>
                                                <th>Asig. Numérica</th>
                                                <th>Descripción</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredExistingEquipment" :key="product.id">
                                                <td><code>{{ product.sku }}</code></td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td>{{ product.brand || 'Sin marca' }}</td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number || 'Sin serie' }}</small></td>
                                                <td>
                                                    <span class="badge bg-warning text-dark">
                                                        {{ product.department || 'Sin asignar' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        {{ product.stock_quantity || 0 }}
                                                    </span>
                                                </td>
                                                <td><small>{{ extractSpecs(product.description) }}</small></td>
                                                <td><small>{{ extractSubSpecs(product.description) }}</small></td>
                                                <td><code>{{ product.barcode || 'Sin asignar' }}</code></td>
                                                <td><small>{{ extractDescription(product.description) }}</small></td>
                                                <td>
                                                    <span class="badge" :class="getEquipmentStatusBadgeClass(product.status)">
                                                        {{ getEquipmentStatusText(product.status) }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" @click="editProduct(product.id)" title="Editar">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" @click="deleteProduct(product.id)" title="Eliminar">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr v-if="filteredExistingEquipment.length === 0">
                                                <td colspan="13" class="text-center text-muted py-4">
                                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                                    <span v-if="existingEquipment.length === 0">
                                                        No hay equipos existentes registrados. Haz clic en "Agregar Producto" para comenzar.
                                                    </span>
                                                    <span v-else>
                                                        No se encontraron equipos con los filtros aplicados.
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sites View -->
                    <div v-if="currentView === 'sites'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Sitios
                                </h5>
                                <button class="btn btn-primary mt-2 mt-md-0" onclick="openModalForSite()">
                                    <i class="fas fa-plus me-1"></i>
                                    Agregar Sitio
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Filtros y Exportar -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="filterSiteDepartment" class="form-label">Filtrar por Sitio</label>
                                        <select class="form-select" id="filterSiteDepartment" v-model="sitesFilters.department" @change="filterSites">
                                            <option value="">Todos los sitios</option>
                                            <option v-for="dept in uniqueSitesDepartments" :key="dept" :value="dept">
                                                {{ dept }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="filterSiteNumericAssign" class="form-label">Filtrar por Asig. Numérica</label>
                                        <input type="text" class="form-control" id="filterSiteNumericAssign" 
                                               v-model="sitesFilters.numericAssign" 
                                               @input="filterSites"
                                               placeholder="Buscar por Asig. Numérica...">
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-info w-100" @click="importSitesFromExcel" title="Importar desde Excel">
                                            <i class="fas fa-file-upload me-2"></i>
                                            Importar Excel
                                        </button>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-success w-100" @click="exportSitesToExcel">
                                            <i class="fas fa-file-excel me-2"></i>
                                            Exportar a Excel
                                        </button>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end" v-if="selectedSites.length > 0">
                                        <button class="btn btn-danger w-100" @click="deleteSelectedSites">
                                            <i class="fas fa-trash me-2"></i>
                                            Eliminar ({{ selectedSites.length }})
                                        </button>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-warning w-100" @click="deleteAllSites" title="Eliminar todos los sitios (para pruebas)">
                                            <i class="fas fa-trash-alt me-2"></i>
                                            Limpiar Todo
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tabla de Sitios -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th style="width: 40px;">
                                                    <input type="checkbox" @change="toggleSelectAllSites" :checked="selectedSites.length === filteredSites.length && filteredSites.length > 0">
                                                </th>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serie</th>
                                                <th>Sitio</th>
                                                <th>Cantidad</th>
                                                <th>Especificaciones/EXT</th>
                                                <th>Sub-Especific</th>
                                                <th>Asig. Numérica</th>
                                                <th>Descripción</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredSites" :key="product.id">
                                                <td>
                                                    <input type="checkbox" :value="product.id" v-model="selectedSites">
                                                </td>
                                                <td><code>{{ product.sku }}</code></td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td>{{ product.brand || 'Sin marca' }}</td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number || 'Sin serie' }}</small></td>
                                                <td>
                                                    <span class="badge bg-warning text-dark">
                                                        {{ product.department || 'Sin asignar' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        {{ product.stock_quantity || 0 }}
                                                    </span>
                                                </td>
                                                <td><small>{{ extractSpecs(product.description) }}</small></td>
                                                <td><small>{{ extractSubSpecs(product.description) }}</small></td>
                                                <td><code>{{ product.barcode || 'Sin asignar' }}</code></td>
                                                <td><small>{{ extractDescription(product.description) }}</small></td>
                                                <td>
                                                    <span class="badge" :class="getEquipmentStatusBadgeClass(product.status)">
                                                        {{ getEquipmentStatusText(product.status) }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" @click="editProduct(product.id)" title="Editar">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" @click="deleteProduct(product.id)" title="Eliminar">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr v-if="filteredSites.length === 0">
                                                <td colspan="14" class="text-center text-muted py-4">
                                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                                    <span v-if="sites.length === 0">
                                                        No hay sitios registrados. Haz clic en "Agregar Sitio" para comenzar.
                                                    </span>
                                                    <span v-else>
                                                        No se encontraron sitios con los filtros aplicados.
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categories View -->
                    <div v-if="currentView === 'categories'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-tags me-2"></i>
                                        Gestión de Categorías
                                    </h5>
                                </div>
                                <button class="btn btn-primary mt-2 mt-md-0">
                                    <i class="fas fa-plus me-1"></i>
                                    Nueva Categoría
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Productos</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="category in categories" :key="category.id">
                                                <td>{{ category.id }}</td>
                                                <td>{{ category.name }}</td>
                                                <td>{{ category.description }}</td>
                                                <td>
                                                    <span class="badge bg-success">{{ category.product_count }}</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suppliers View -->
                    <div v-if="currentView === 'suppliers'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-truck me-2"></i>
                                        Gestión de Proveedores
                                    </h5>
                                </div>
                                <button class="btn btn-primary mt-2 mt-md-0">
                                    <i class="fas fa-plus me-1"></i>
                                    Nuevo Proveedor
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Contacto</th>
                                                <th>Email</th>
                                                <th>Teléfono</th>
                                                <th>Productos</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="supplier in suppliers" :key="supplier.id">
                                                <td>{{ supplier.id }}</td>
                                                <td>{{ supplier.name }}</td>
                                                <td>{{ supplier.contact_person }}</td>
                                                <td>{{ supplier.email }}</td>
                                                <td>{{ supplier.phone }}</td>
                                                <td>
                                                    <span class="badge bg-success">{{ supplier.product_count }}</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports View -->
                    <div v-if="currentView === 'reports'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Reportes del Sistema
                                    </h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-chart-pie fa-3x mb-3" style="color: #FFD700;"></i>
                                                <h5>Reporte de Inventario</h5>
                                                <p class="text-muted">Resumen completo del inventario</p>
                                                <button class="btn btn-primary">Generar Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-exclamation-triangle fa-3x mb-3" style="color: #ffc107;"></i>
                                                <h5>Stock Bajo</h5>
                                                <p class="text-muted">Productos con stock bajo</p>
                                                <button class="btn btn-primary">Ver Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-dollar-sign fa-3x mb-3" style="color: #28a745;"></i>
                                                <h5>Valor del Inventario</h5>
                                                <p class="text-muted">Valor total del inventario</p>
                                                <button class="btn btn-primary">Ver Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-truck fa-3x mb-3" style="color: #6c757d;"></i>
                                                <h5>Reporte de Proveedores</h5>
                                                <p class="text-muted">Análisis de proveedores</p>
                                                <button class="btn btn-primary">Generar Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div v-if="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="text-center text-white">
                            <div class="loading-spinner mb-3"></div>
                            <p>Cargando...</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentView: 'dashboard',
                    loading: false,
                    user: { name: 'Cargando...', email: '', role: 'guest' },
                    products: [],
                    filteredProducts: [],
                    productFilter: 'all', // 'all', 'telecomunicacion', 'computo'
                    recentProducts: [],
                    lowStockProducts: [],
                    categories: [],
                    suppliers: [],
                    departments: [],
                    locations: [],
                    inventorySummary: {},
                    filteredInventory: [],
                    inventoryFilters: {
                        category: '',
                        location: '',
                        search: ''
                    },
                    searchQuery: '',
                    selectedCategory: '',
                    selectedSupplier: '',
                    showEditProductModal: false,
                    editingProduct: null,
                    _mounted: false, // Flag para prevenir múltiples mountings
                    existingEquipment: [], // Equipos existentes
                    filteredExistingEquipment: [], // Equipos existentes filtrados
                    existingEquipmentFilters: {
                        department: '',
                        numericAssign: ''
                    },
                    sites: [], // Sitios
                    filteredSites: [], // Sitios filtrados
                    sitesFilters: {
                        department: '',
                        numericAssign: ''
                    },
                    selectedSites: [] // Sitios seleccionados para eliminar
                }
            },
            async mounted() {
                if (this._mounted) {
                    console.log('Mounted ya fue llamado, omitiendo...');
                    return;
                }
                this._mounted = true;
                console.log('Mounted ejecutándose por primera vez...');
                
                // Verificar si hay cookies de sesión antes de intentar cargar el usuario
                console.log('🍪 Verificando cookies de sesión:', document.cookie);
                
                await this.loadSessionUser();
                this.loadProducts();
                this.loadCategories();
                this.loadSuppliers();
                this.loadDepartments();
                this.loadLocations();
                this.loadInventorySummary();
            },
            methods: {
                async loadSessionUser() {
                    try {
                        console.log('🔍 Iniciando carga de sesión de usuario...');
                        const res = await fetch('/auth/me');
                        console.log('📡 Respuesta del servidor:', res.status, res.statusText);
                        
                        if (res.ok) {
                            const data = await res.json();
                            console.log('📦 Datos recibidos:', data);
                            
                            if (data.success && data.authenticated) {
                                this.user = data.data;
                                console.log('✅ Usuario autenticado cargado:', this.user);
                            } else {
                                console.error('❌ NO HAY SESIÓN ACTIVA - Datos recibidos:', data);
                                this.user = { name: 'No autenticado', email: '', role: 'guest' };
                                // NO redirigir automáticamente, solo mostrar el estado
                                console.log('⚠️ Sin sesión activa, usuario en modo invitado');
                            }
                        } else {
                            console.error('❌ ERROR EN RESPUESTA DEL SERVIDOR:', res.status);
                            this.user = { name: 'Error de conexión', email: '', role: 'guest' };
                            console.log('⚠️ Error del servidor, usuario en modo invitado');
                        }
                    } catch (error) {
                        console.error('❌ Error al cargar usuario:', error);
                        this.user = { name: 'Error de conexión', email: '', role: 'guest' };
                        console.log('⚠️ Error de conexión, usuario en modo invitado');
                    }
                    
                    console.log('👤 Usuario final asignado:', this.user);
                    
                    // Actualizar el DOM para mostrar el usuario real
                    if (this.user && this.user.role !== 'guest') {
                        console.log('✅ Usuario real detectado, rol:', this.user.role);
                    } else {
                        console.log('⚠️ Usuario no autenticado (guest)');
                    }
                },
                setView(view) {
                    this.currentView = view;
                    if (view === 'products') {
                        this.loadProducts();
                    } else if (view === 'existing-equipment') {
                        this.loadProducts(); // Cargar productos para actualizar equipos existentes
                    } else if (view === 'sites') {
                        this.loadProducts(); // Cargar productos para actualizar sitios
                    }
                },
                setProductFilter(filter) {
                    console.log('setProductFilter called with:', filter);
                    this.productFilter = filter;
                    console.log('productFilter set to:', this.productFilter);
                    this.filterProducts();
                },
                
                getPageTitle() {
                    const titles = {
                        'dashboard': 'Dashboard',
                        'products': 'Productos',
                        'existing-equipment': 'Equipos existentes',
                        'sites': 'Sitios',
                        'categories': 'Categorías',
                        'suppliers': 'Proveedores',
                        'reports': 'Reportes',
                        'settings': 'Configuración'
                    };
                    return titles[this.currentView] || 'Sistema de Inventario';
                },


                async loadProducts() {
                    this.loading = true;
                    try {
                        const response = await fetch('/products');
                        const responseText = await response.text();
                        let data;
                        try {
                            data = JSON.parse(responseText);
                        } catch (e) {
                            console.error('Error parsing products response:', e);
                            console.error('Response was:', responseText.substring(0, 200));
                            if (responseText.includes('<!DOCTYPE')) {
                                console.error('El servidor está devolviendo HTML en lugar de JSON. Asegúrate de acceder a través de index.php, no index.html directamente.');
                            }
                            this.loading = false;
                            return;
                        }
                        if (data.success) {
                            this.products = data.data;
                            this.filterProducts(); // Aplicar filtro actual
                            this.recentProducts = data.data.slice(0, 10);
                            // También actualizar filteredInventory
                            this.filteredInventory = data.data;
                            // Actualizar equipos existentes (solo los que tienen type === 'existing_equipment')
                            this.existingEquipment = data.data.filter(product => product.type === 'existing_equipment');
                            // Inicializar equipos filtrados
                            this.filterExistingEquipment();
                            // Actualizar sitios (solo los que tienen type === 'sitio')
                            this.sites = data.data.filter(product => product.type === 'sitio');
                            // Inicializar sitios filtrados
                            this.filterSites();
                        }
                    } catch (error) {
                        console.error('Error loading products:', error);
                    }
                    this.loading = false;
                },

                async loadCategories() {
                    try {
                        const response = await fetch('/categories');
                        const data = await response.json();
                        if (data.success) {
                            this.categories = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading categories:', error);
                    }
                },

                async loadSuppliers() {
                    try {
                        const response = await fetch('/suppliers');
                        const data = await response.json();
                        if (data.success) {
                            this.suppliers = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading suppliers:', error);
                    }
                },

                async loadDepartments() {
                    try {
                        const response = await fetch('/departments');
                        const data = await response.json();
                        if (data.success) {
                            this.departments = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading departments:', error);
                    }
                },

                async loadLocations() {
                    try {
                        const response = await fetch('/locations');
                        const data = await response.json();
                        if (data.success) {
                            this.locations = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading locations:', error);
                    }
                },

                async loadInventorySummary() {
                    try {
                        const response = await fetch('/inventory/summary');
                        const data = await response.json();
                        if (data.success) {
                            this.inventorySummary = data.data;
                            // Inicializar filteredInventory con todos los productos
                            this.filteredInventory = this.products.length > 0 ? this.products : [];
                        }
                    } catch (error) {
                        console.error('Error loading inventory summary:', error);
                        // Si hay error, usar los productos locales
                        this.filteredInventory = this.products;
                    }
                },

                filterInventory() {
                    let filtered = [...this.products];
                    
                    if (this.inventoryFilters.category) {
                        filtered = filtered.filter(product => 
                            product.category_name === this.inventoryFilters.category
                        );
                    }
                    
                    if (this.inventoryFilters.location) {
                        filtered = filtered.filter(product => 
                            product.location.includes(this.inventoryFilters.location)
                        );
                    }
                    
                    if (this.inventoryFilters.search) {
                        const search = this.inventoryFilters.search.toLowerCase();
                        filtered = filtered.filter(product => 
                            product.sku.toLowerCase().includes(search) ||
                            product.name.toLowerCase().includes(search) ||
                            product.serial_number.toLowerCase().includes(search) ||
                            product.label.toLowerCase().includes(search)
                        );
                    }
                    
                    this.filteredInventory = filtered;
                },

                refreshInventory() {
                    this.loadInventorySummary();
                    this.loadProducts();
                },

                searchInventory() {
                    // Aplicar filtros y mostrar resultados
                    this.filterInventory();
                },

                showAddProduct() {
                    // Esta función ya no se usa, se reemplazó por openModal() de JavaScript vanilla
                },

                closeAddProductModal() {
                    // Esta función ya no se usa, se reemplazó por closeModal() de JavaScript vanilla
                },

                editProduct(productOrId) {
                    let product = null;
                    
                    if (productOrId && typeof productOrId === 'object') {
                        product = productOrId;
                    } else {
                        const idToFind = productOrId ?? null;
                        product = this.products.find(p => p.id == idToFind) 
                            || this.filteredProducts.find(p => p.id == idToFind) 
                            || this.filteredInventory.find(p => p.id == idToFind);
                    }
                    
                    if (!product) {
                        console.error('editProduct: producto no encontrado', productOrId);
                        alert('No se pudo cargar el producto para editar.');
                        return;
                    }
                    
                    openEditModalWithProduct(product);
                },

                updateProduct() {
                    if (!this.editingProduct) return;
                    
                    // Validar campos requeridos
                    if (!this.editingProduct.sku || !this.editingProduct.name || !this.editingProduct.serial_number) {
                        alert('Por favor completa todos los campos requeridos');
                        return;
                    }
                    
                    // Validar SKU único (excluyendo el producto actual)
                    if (this.products.some(p => p.id !== this.editingProduct.id && p.sku.toLowerCase() === this.editingProduct.sku.toLowerCase())) {
                        alert('El SKU ya existe. Por favor usa un SKU diferente.');
                        return;
                    }
                    
                    // Validar número de serial único (excluyendo el producto actual)
                    if (this.products.some(p => p.id !== this.editingProduct.id && p.serial_number.toLowerCase() === this.editingProduct.serial_number.toLowerCase())) {
                        alert('El número de serial ya existe. Por favor usa un serial diferente.');
                        return;
                    }
                    
                    // Actualizar fecha de modificación
                    this.editingProduct.updated_at = new Date().toISOString().slice(0, 19).replace('T', ' ');
                    
                    // Buscar y actualizar el producto en la lista
                    const index = this.products.findIndex(p => p.id === this.editingProduct.id);
                    if (index !== -1) {
                        this.products[index] = { ...this.editingProduct };
                    }
                    
                    // Actualizar en filteredProducts
                    const filteredIndex = this.filteredProducts.findIndex(p => p.id === this.editingProduct.id);
                    if (filteredIndex !== -1) {
                        this.filteredProducts[filteredIndex] = { ...this.editingProduct };
                    }
                    
                    // Actualizar en filteredInventory
                    const inventoryIndex = this.filteredInventory.findIndex(p => p.id === this.editingProduct.id);
                    if (inventoryIndex !== -1) {
                        this.filteredInventory[inventoryIndex] = { ...this.editingProduct };
                    }
                    
                    // Cerrar modal
                    this.showEditProductModal = false;
                    this.editingProduct = null;
                    
                // Mostrar mensaje de éxito más visible
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                successMessage.innerHTML = `
                    <strong>¡Éxito!</strong> Producto actualizado correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(successMessage);
                
                // Auto-remover después de 5 segundos
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.parentNode.removeChild(successMessage);
                    }
                }, 5000);
                    
                    // Recargar datos
                    this.loadInventorySummary();
                },

                cancelEdit() {
                    this.showEditProductModal = false;
                    this.editingProduct = null;
                },

                generateEditBarcode() {
                    // Generar código de barras inteligente para edición
                    let barcode = '';
                    
                    if (this.editingProduct.sku) {
                        // Usar SKU como base
                        const skuClean = this.editingProduct.sku.replace(/[^A-Z0-9]/g, '');
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${skuClean}-${timestamp}`;
                    } else if (this.editingProduct.name) {
                        // Usar primeras letras del nombre
                        const nameWords = this.editingProduct.name.split(' ');
                        const initials = nameWords.map(word => word.charAt(0).toUpperCase()).join('');
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${initials}-${timestamp}`;
                    } else {
                        // Generar código aleatorio
                        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${random}-${timestamp}`;
                    }
                    
                    // Verificar que el código de barras sea único (excluyendo el producto actual)
                    let counter = 1;
                    let finalBarcode = barcode;
                    while (this.products.some(p => p.id !== this.editingProduct.id && p.barcode === finalBarcode)) {
                        finalBarcode = `${barcode}-${counter}`;
                        counter++;
                    }
                    
                    this.editingProduct.barcode = finalBarcode;
                },

                searchProducts() {
                    if (!this.searchQuery) {
                        this.filteredProducts = this.products;
                        return;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    this.filteredProducts = this.products.filter(product => 
                        product.name.toLowerCase().includes(query) ||
                        product.sku.toLowerCase().includes(query) ||
                        product.description.toLowerCase().includes(query)
                    );
                },

                filterProducts() {
                    console.log('filterProducts called with productFilter:', this.productFilter);
                    console.log('Total products:', this.products.length);
                    
                    let filtered = this.products;
                    
                    // Filtrar por tipo de producto
                    if (this.productFilter !== 'all') {
                        console.log('Filtering by type:', this.productFilter);
                        const beforeFilter = filtered.length;
                        filtered = filtered.filter(product => {
                            console.log('Product type:', product.type, 'Filter:', this.productFilter, 'Match:', product.type === this.productFilter);
                            return product.type === this.productFilter;
                        });
                        console.log('After type filter:', filtered.length, 'products (was', beforeFilter, ')');
                    }
                    
                    if (this.selectedCategory) {
                        filtered = filtered.filter(product => product.category_id == this.selectedCategory);
                    }
                    
                    if (this.selectedSupplier) {
                        filtered = filtered.filter(product => product.supplier_id == this.selectedSupplier);
                    }
                    
                    console.log('Final filtered products:', filtered.length);
                    this.filteredProducts = filtered;
                },

                refreshData() {
                    this.loadProducts();
                    this.loadInventorySummary();
                },

                getStockBadgeClass(stock, minStock) {
                    if (stock <= minStock) return 'bg-danger';
                    if (stock <= minStock * 2) return 'bg-warning';
                    return 'bg-success';
                },

                getStatusBadgeClass(stock, minStock) {
                    if (stock <= minStock) return 'bg-danger';
                    if (stock <= minStock * 2) return 'bg-warning';
                    return 'bg-success';
                },

                getStatusText(stock, minStock) {
                    if (stock <= minStock) return 'Stock Bajo';
                    if (stock <= minStock * 2) return 'Stock Medio';
                    return 'En Stock';
                },

                formatNumber(number) {
                    const num = parseFloat(number) || 0;
                    return new Intl.NumberFormat('es-MX').format(num);
                },

                // Métodos para extraer datos de equipos existentes
                extractSpecs(description) {
                    if (!description) return '';
                    const match = description.match(/Especificaciones\/EXT:\s*(.+)/);
                    return match ? match[1].split('\n')[0].trim() : '';
                },

                extractSubSpecs(description) {
                    if (!description) return '';
                    const match = description.match(/Sub-Especific:\s*(.+)/);
                    return match ? match[1].split('\n')[0].trim() : '';
                },

                extractDescription(description) {
                    if (!description) return '';
                    // Obtener solo la descripción principal (antes de Especificaciones/EXT)
                    const lines = description.split('\n');
                    const mainDesc = lines[0];
                    // Si la primera línea contiene "Especificaciones" o "Sub-Especific", no hay descripción principal
                    if (mainDesc.includes('Especificaciones') || mainDesc.includes('Sub-Especific')) {
                        return '';
                    }
                    return mainDesc.trim();
                },

                getEquipmentStatusBadgeClass(status) {
                    if (status === 'active' || status === 'operativo') return 'bg-success';
                    if (status === 'maintenance' || status === 'criterio_tecnico') return 'bg-warning text-dark';
                    if (status === 'inactive' || status === 'descarte') return 'bg-secondary';
                    return 'bg-secondary';
                },

                getEquipmentStatusText(status) {
                    const statusMap = {
                        'active': 'Operativo',
                        'operativo': 'Operativo',
                        'maintenance': 'Criterio Técnico',
                        'criterio_tecnico': 'Criterio Técnico',
                        'inactive': 'Descarte',
                        'descarte': 'Descarte'
                    };
                    return statusMap[status] || status || 'Desconocido';
                },

                filterExistingEquipment() {
                    let filtered = [...this.existingEquipment];
                    
                    // Filtrar por departamento
                    if (this.existingEquipmentFilters.department) {
                        filtered = filtered.filter(product => 
                            product.department && 
                            product.department.toLowerCase() === this.existingEquipmentFilters.department.toLowerCase()
                        );
                    }
                    
                    // Filtrar por Asig. Numérica (barcode)
                    if (this.existingEquipmentFilters.numericAssign) {
                        const searchTerm = this.existingEquipmentFilters.numericAssign.toLowerCase();
                        filtered = filtered.filter(product => 
                            product.barcode && 
                            product.barcode.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    this.filteredExistingEquipment = filtered;
                },

                exportExistingEquipmentToExcel() {
                    // Los datos a exportar son los que están filtrados
                    const dataToExport = this.filteredExistingEquipment;
                    
                    if (dataToExport.length === 0) {
                        alert('No hay datos para exportar con los filtros aplicados.');
                        return;
                    }
                    
                    // Preparar los datos para Excel
                    const excelData = dataToExport.map(product => ({
                        'SKU': product.sku || '',
                        'Nombre': product.name || '',
                        'Marca': product.brand || '',
                        'Modelo': product.model || '',
                        'Serie': product.serial_number || '',
                        'Departamento': product.department || 'Sin asignar',
                        'Cantidad': product.stock_quantity || 0,
                        'Especificaciones/EXT': this.extractSpecs(product.description) || '',
                        'Sub-Especific': this.extractSubSpecs(product.description) || '',
                        'Asig. Numérica': product.barcode || 'Sin asignar',
                        'Descripción': this.extractDescription(product.description) || '',
                        'Estado': this.getEquipmentStatusText(product.status),
                        'photo_url': product.photo_url || '' // Incluir URL de la foto
                    }));
                    
                    // Llamar a la función de exportación (se implementará después)
                    this.downloadExcel(excelData, 'Equipos_Existentes');
                },

                filterSites() {
                    let filtered = [...this.sites];
                    
                    // Filtrar por departamento/sitio
                    if (this.sitesFilters.department) {
                        filtered = filtered.filter(product => 
                            product.department && 
                            product.department.toLowerCase() === this.sitesFilters.department.toLowerCase()
                        );
                    }
                    
                    // Filtrar por Asig. Numérica (barcode)
                    if (this.sitesFilters.numericAssign) {
                        const searchTerm = this.sitesFilters.numericAssign.toLowerCase();
                        filtered = filtered.filter(product => 
                            product.barcode && 
                            product.barcode.toLowerCase().includes(searchTerm)
                        );
                    }
                    
                    this.filteredSites = filtered;
                    
                    // Limpiar selección de sitios que ya no están visibles
                    this.selectedSites = this.selectedSites.filter(id => 
                        filtered.some(p => p.id === id)
                    );
                },

                exportSitesToExcel() {
                    // Los datos a exportar son los que están filtrados
                    const dataToExport = this.filteredSites;
                    
                    if (dataToExport.length === 0) {
                        alert('No hay datos para exportar con los filtros aplicados.');
                        return;
                    }
                    
                    // Preparar los datos para Excel
                    const excelData = dataToExport.map(product => ({
                        'SKU': product.sku || '',
                        'Nombre': product.name || '',
                        'Marca': product.brand || '',
                        'Modelo': product.model || '',
                        'Serie': product.serial_number || '',
                        'Sitio': product.department || 'Sin asignar',
                        'Lugar': product.lugar || '',
                        'Cantidad': product.stock_quantity || 0,
                        'Especificaciones/EXT': this.extractSpecs(product.description) || '',
                        'Sub-Especific': this.extractSubSpecs(product.description) || '',
                        'Asig. Numérica': product.barcode || 'Sin asignar',
                        'Descripción': this.extractDescription(product.description) || '',
                        'Estado': this.getEquipmentStatusText(product.status),
                        'photo_url': product.photo_url || '' // Incluir URL de la foto
                    }));
                    
                    // Llamar a la función de exportación
                    this.downloadExcel(excelData, 'Sitios');
                },

                toggleSelectAllSites(event) {
                    if (event.target.checked) {
                        // Seleccionar todos los sitios filtrados
                        this.selectedSites = this.filteredSites.map(p => p.id);
                    } else {
                        // Deseleccionar todos
                        this.selectedSites = [];
                    }
                },

                deleteSelectedSites() {
                    if (this.selectedSites.length === 0) {
                        alert('No hay sitios seleccionados para eliminar');
                        return;
                    }
                    
                    const count = this.selectedSites.length;
                    const confirmMessage = count === 1 
                        ? `¿Estás seguro de eliminar ${count} sitio?`
                        : `¿Estás seguro de eliminar ${count} sitios?`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Eliminar uno por uno
                    let deleted = 0;
                    let failed = 0;
                    const errors = [];
                    
                    const deleteNext = (index) => {
                        if (index >= this.selectedSites.length) {
                            // Mostrar resumen
                            const message = `Eliminación completada:\n- Eliminados: ${deleted}\n- Fallidos: ${failed}${errors.length > 0 ? '\n\nErrores:\n' + errors.slice(0, 5).join('\n') : ''}`;
                            alert(message);
                            
                            // Limpiar selección
                            this.selectedSites = [];
                            
                            // Recargar productos
                            this.loadProducts();
                            return;
                        }
                        
                        const productId = this.selectedSites[index];
                        
                        fetch('/api/products', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ id: productId })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                deleted++;
                            } else {
                                failed++;
                                errors.push(`ID ${productId}: ${data.error || data.message || 'Error desconocido'}`);
                            }
                            // Continuar con el siguiente
                            deleteNext(index + 1);
                        })
                        .catch(error => {
                            failed++;
                            errors.push(`ID ${productId}: ${error.message}`);
                            // Continuar con el siguiente
                            deleteNext(index + 1);
                        });
                    };
                    
                    // Iniciar eliminación
                    deleteNext(0);
                },

                async deleteAllSites() {
                    if (!confirm('⚠️ ADVERTENCIA: Esto eliminará TODOS los productos de tipo "sitio".\n\n¿Estás seguro de continuar?')) {
                        return;
                    }
                    
                    // Cargar todos los sitios
                    let allSites = [];
                    try {
                        const response = await fetch('/api/products');
                        const data = await response.json();
                        if (data.success && data.data) {
                            allSites = data.data.filter(p => p.type === 'sitio');
                        }
                    } catch (error) {
                        console.error('Error al cargar sitios:', error);
                        alert('Error al cargar los sitios: ' + error.message);
                        return;
                    }
                    
                    if (allSites.length === 0) {
                        alert('No hay sitios para eliminar');
                        return;
                    }
                    
                    if (!confirm(`Se eliminarán ${allSites.length} sitios. ¿Continuar?`)) {
                        return;
                    }
                    
                    let deleted = 0;
                    let failed = 0;
                    const errors = [];
                    
                    const deleteNext = (index) => {
                        if (index >= allSites.length) {
                            const message = `Eliminación completada:\n- Eliminados: ${deleted}\n- Fallidos: ${failed}${errors.length > 0 ? '\n\nErrores:\n' + errors.slice(0, 10).join('\n') : ''}`;
                            alert(message);
                            
                            // Recargar productos
                            if (window.app && window.app.loadProducts) {
                                window.app.loadProducts();
                            }
                            return;
                        }
                        
                        const product = allSites[index];
                        
                        fetch('/api/products', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ id: product.id })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                deleted++;
                            } else {
                                failed++;
                                errors.push(`ID ${product.id} (${product.sku}): ${data.error || data.message || 'Error desconocido'}`);
                            }
                            // Continuar con el siguiente
                            deleteNext(index + 1);
                        })
                        .catch(error => {
                            failed++;
                            errors.push(`ID ${product.id} (${product.sku}): ${error.message}`);
                            // Continuar con el siguiente
                            deleteNext(index + 1);
                        });
                    };
                    
                    // Iniciar eliminación
                    deleteNext(0);
                },

                async importSitesFromExcel() {
                    // Crear input de archivo
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.xlsx,.xls';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const data = new Uint8Array(event.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                
                                // Obtener la primera hoja
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                
                                // Convertir a JSON
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                                
                                if (jsonData.length < 2) {
                                    alert('El archivo Excel está vacío o no tiene datos');
                                    return;
                                }
                                
                                // Buscar automáticamente la fila de headers (puede haber títulos antes)
                                let headerRowIndex = -1;
                                let headers = [];
                                
                                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                                    const row = jsonData[i];
                                    if (!row || row.length === 0) continue;
                                    
                                    const rowHeaders = row.map(h => String(h || '').trim().toUpperCase());
                                    const hasPlaca = rowHeaders.some(h => h.includes('PLACA'));
                                    const hasEquipo = rowHeaders.some(h => h.includes('EQUIPO'));
                                    const hasMarca = rowHeaders.some(h => h.includes('MARCA'));
                                    
                                    // Si encontramos al menos 2 de las columnas clave, esta es la fila de headers
                                    if ((hasPlaca && hasEquipo) || (hasPlaca && hasMarca) || (hasEquipo && hasMarca)) {
                                        headerRowIndex = i;
                                        headers = rowHeaders;
                                        break;
                                    }
                                }
                                
                                if (headerRowIndex === -1) {
                                    alert('No se encontraron los headers del Excel. Asegúrese de que el archivo contenga las columnas: PLACA, EQUIPO, MARCA');
                                    return;
                                }
                                
                                // Buscar índices de columnas
                                const placaIndex = headers.findIndex(h => h.includes('PLACA'));
                                const equipoIndex = headers.findIndex(h => h.includes('EQUIPO'));
                                const marcaIndex = headers.findIndex(h => h.includes('MARCA'));
                                const modeloIndex = headers.findIndex(h => h.includes('MODELO'));
                                const serieIndex = headers.findIndex(h => h.includes('SERIE'));
                                const lugarIndex = headers.findIndex(h => h.includes('LUGAR'));
                                const estadoIndex = headers.findIndex(h => h.includes('ESTADO'));
                                
                                // Cargar productos existentes para verificar duplicados
                                let existingProducts = [];
                                try {
                                    const response = await fetch('/api/products');
                                    const data = await response.json();
                                    if (data.success && data.data) {
                                        existingProducts = data.data;
                                    }
                                } catch (error) {
                                    console.error('Error al cargar productos existentes:', error);
                                }
                                
                                // Crear mapa de barcodes existentes para verificación rápida
                                const existingBarcodes = new Set();
                                // Crear mapa de productos sin PLACA: clave = "nombre|sitio" para verificar duplicados
                                const existingProductsWithoutBarcode = new Map();
                                
                                existingProducts.forEach(p => {
                                    if (p.barcode && p.barcode.trim() !== '') {
                                        existingBarcodes.add(p.barcode.toString().trim().toUpperCase());
                                    } else {
                                        // Si no tiene PLACA, usar nombre + sitio como identificador
                                        const nombre = (p.name || p.description || '').trim().toUpperCase();
                                        const sitio = (p.department || '').trim().toUpperCase();
                                        if (nombre && sitio) {
                                            const key = `${nombre}|${sitio}`;
                                            existingProductsWithoutBarcode.set(key, p);
                                        }
                                    }
                                });
                                
                                // Procesar filas (empezar después de la fila de headers)
                                const productsToImport = [];
                                const failedProducts = []; // Productos que fallaron con detalles
                                let skippedCount = 0; // Productos saltados por no encontrar sitio
                                let duplicateCount = 0; // Productos duplicados
                                
                                for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                                    const row = jsonData[i];
                                    if (!row || row.length === 0) continue;
                                    
                                    // Mapear columnas según el formato del Excel
                                    const placa = placaIndex >= 0 ? String(row[placaIndex] || '').trim() : '';
                                    const equipo = equipoIndex >= 0 ? String(row[equipoIndex] || '').trim() : '';
                                    const marca = marcaIndex >= 0 ? String(row[marcaIndex] || '').trim() : '';
                                    const modelo = modeloIndex >= 0 ? String(row[modeloIndex] || '').trim() : '';
                                    const serie = serieIndex >= 0 ? String(row[serieIndex] || '').trim() : '';
                                    const lugar = lugarIndex >= 0 ? String(row[lugarIndex] || '').trim() : '';
                                    const estado = estadoIndex >= 0 ? String(row[estadoIndex] || '').trim() : '';
                                    
                                    // Validar que tenga al menos PLACA o EQUIPO
                                    if (!placa && !equipo) {
                                        failedProducts.push({
                                            placa: placa || 'N/A',
                                            equipo: equipo || 'N/A',
                                            razon: 'Falta PLACA y EQUIPO'
                                        });
                                        continue;
                                    }
                                    
                                    // Extraer sitio primero para poder verificar duplicados correctamente
                                    // (necesitamos el sitio antes de verificar duplicados sin PLACA)
                                    let sitio = '';
                                    const sitiosList = [
                                        'Cerro Ancón', 'Edificio Pradera', 'Cerro Oscuro', 'Palacio',
                                        'Cerro Galera', 'Cerro Santa Rita', 'Cerro Jefe', 'Cerro Buenos Aires Chepo',
                                        'Aguas Frías', 'Cerro Mena', 'Cerro La Silla', 'Cerro Taboga',
                                        'Cerro Canajagua', 'Cerro Peña', 'Cerro Boca Viento', 'Cerro Zancudo',
                                        'Meseta de Chorcha'
                                    ];
                                    
                                    // Función para normalizar texto (sin acentos, mayúsculas, espacios)
                                    const normalize = (text) => {
                                        return text.toUpperCase()
                                            .replace(/Á/g, 'A').replace(/É/g, 'E').replace(/Í/g, 'I')
                                            .replace(/Ó/g, 'O').replace(/Ú/g, 'U').replace(/Ñ/g, 'N')
                                            .replace(/\s+/g, ' ').trim();
                                    };
                                    
                                    if (lugar) {
                                        const lugarUpper = lugar.toUpperCase().trim();
                                        const lugarNormalized = normalize(lugar);
                                        
                                        // Primero: buscar coincidencias exactas del nombre completo del sitio
                                        for (const sitioItem of sitiosList) {
                                            const sitioUpper = sitioItem.toUpperCase();
                                            const sitioNormalized = normalize(sitioItem);
                                            
                                            // Buscar si el lugar contiene el nombre completo del sitio
                                            if (lugarUpper.includes(sitioUpper) || lugarNormalized.includes(sitioNormalized)) {
                                                sitio = sitioItem;
                                                break;
                                            }
                                        }
                                        
                                        // Segundo: si no se encontró, buscar por el nombre después de "CERRO"
                                        if (!sitio) {
                                            const match = lugarUpper.match(/CERRO\s+([A-ZÁÉÍÓÚÑ\s]+?)(?:\s|$|-|,)/);
                                            if (match) {
                                                const cerroName = normalize(match[1].trim());
                                                
                                                for (const sitioItem of sitiosList) {
                                                    if (sitioItem.startsWith('Cerro ')) {
                                                        const nombreSitio = normalize(sitioItem.substring(6));
                                                        if (nombreSitio === cerroName || 
                                                            nombreSitio.includes(cerroName) || 
                                                            cerroName.includes(nombreSitio)) {
                                                            sitio = sitioItem;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        
                                        // Tercero: buscar sitios que no empiezan con "Cerro"
                                        if (!sitio) {
                                            for (const sitioItem of sitiosList) {
                                                if (!sitioItem.startsWith('Cerro ')) {
                                                    const sitioNormalized = normalize(sitioItem);
                                                    if (lugarNormalized.includes(sitioNormalized)) {
                                                        sitio = sitioItem;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    
                                    // Si NO se encontró el sitio, NO agregar el producto
                                    if (!sitio) {
                                        skippedCount++;
                                        failedProducts.push({
                                            placa: placa || 'N/A',
                                            equipo: equipo || 'N/A',
                                            lugar: lugar || 'N/A',
                                            razon: `Sitio no encontrado en los 17 sitios válidos. Lugar: "${lugar}"`
                                        });
                                        console.log('Sitio no encontrado para lugar:', lugar, '- Producto NO agregado');
                                        continue; // Saltar este producto
                                    }
                                    
                                    // Verificar duplicados
                                    let isDuplicate = false;
                                    
                                    // 1. Si tiene PLACA, verificar por PLACA (sin importar sitio)
                                    if (placa && placa.trim() !== '') {
                                        const placaUpper = placa.toUpperCase();
                                        if (existingBarcodes.has(placaUpper)) {
                                            isDuplicate = true;
                                            duplicateCount++;
                                            failedProducts.push({
                                                placa: placa,
                                                equipo: equipo || 'N/A',
                                                sitio: sitio,
                                                razon: 'PLACA ya existe en la base de datos (duplicado)'
                                            });
                                        }
                                    } else {
                                        // 2. Si NO tiene PLACA, verificar por nombre + sitio
                                        const nombreEquipo = (equipo || marca || 'Equipo Importado').trim().toUpperCase();
                                        const sitioUpper = sitio.toUpperCase();
                                        const key = `${nombreEquipo}|${sitioUpper}`;
                                        
                                        if (existingProductsWithoutBarcode.has(key)) {
                                            isDuplicate = true;
                                            duplicateCount++;
                                            failedProducts.push({
                                                placa: placa || 'Sin PLACA',
                                                equipo: equipo || 'N/A',
                                                sitio: sitio,
                                                razon: `Producto con mismo nombre "${equipo || 'N/A'}" ya existe en el sitio "${sitio}" (duplicado)`
                                            });
                                        }
                                    }
                                    
                                    if (isDuplicate) {
                                        continue; // Saltar este producto
                                    }
                                    
                                    // Generar SKU único
                                    const autoSKU = generateUniqueSKU();
                                    
                                    // Mapear estado
                                    const statusMap = {
                                        'operativo': 'active',
                                        'criterio_tecnico': 'maintenance',
                                        'descarte': 'inactive',
                                        'active': 'active',
                                        'maintenance': 'maintenance',
                                        'inactive': 'inactive'
                                    };
                                    const mappedStatus = estado ? (statusMap[estado.toLowerCase()] || 'active') : 'active';
                                    
                                    console.log('Lugar:', lugar, '-> Sitio detectado:', sitio);
                                    
                                    // Si la PLACA está vacía, generar una temporal pero no verificar duplicados
                                    const barcodeToUse = placa || `INV-${autoSKU}`;
                                    
                                    const productData = {
                                        sku: autoSKU,
                                        name: equipo || marca || 'Equipo Importado',
                                        description: equipo || '',
                                        brand: marca || '',
                                        model: modelo || '',
                                        serial_number: serie || autoSKU,
                                        department: sitio,
                                        lugar: lugar || null,
                                        label: serie || autoSKU,
                                        barcode: barcodeToUse,
                                        stock_quantity: 1,
                                        price: 0,
                                        cost: 0,
                                        category_id: 1,
                                        supplier_id: 1,
                                        type: 'sitio',
                                        status: mappedStatus,
                                        photo_url: null
                                    };
                                    
                                    productsToImport.push(productData);
                                    
                                    // Agregar a la lista de barcodes para evitar duplicados en el mismo archivo
                                    if (placa && placa.trim() !== '') {
                                        existingBarcodes.add(placa.toUpperCase());
                                    } else {
                                        // Si no tiene PLACA, agregar al mapa de productos sin PLACA
                                        const nombreEquipo = (equipo || marca || 'Equipo Importado').trim().toUpperCase();
                                        const sitioUpper = sitio.toUpperCase();
                                        const key = `${nombreEquipo}|${sitioUpper}`;
                                        existingProductsWithoutBarcode.set(key, productData);
                                    }
                                }
                                
                                if (productsToImport.length === 0) {
                                    let message = 'No se encontraron datos válidos para importar.';
                                    if (failedProducts.length > 0 || skippedCount > 0 || duplicateCount > 0) {
                                        message += `\n\nResumen:\n`;
                                        if (duplicateCount > 0) message += `- Duplicados: ${duplicateCount}\n`;
                                        if (skippedCount > 0) message += `- Sitio no encontrado: ${skippedCount}\n`;
                                        if (failedProducts.length > duplicateCount + skippedCount) {
                                            message += `- Otros errores: ${failedProducts.length - duplicateCount - skippedCount}\n`;
                                        }
                                    }
                                    alert(message);
                                    return;
                                }
                                
                                // Confirmar importación
                                let confirmMessage = `Se importarán ${productsToImport.length} registros.`;
                                if (duplicateCount > 0 || skippedCount > 0) {
                                    confirmMessage += `\n\nProductos que NO se importarán:`;
                                    if (duplicateCount > 0) confirmMessage += `\n- Duplicados: ${duplicateCount} (PLACA ya existe)`;
                                    if (skippedCount > 0) confirmMessage += `\n- Sitio no encontrado: ${skippedCount}`;
                                }
                                confirmMessage += '\n\n¿Desea continuar?';
                                if (!confirm(confirmMessage)) {
                                    return;
                                }
                                
                                // Importar productos uno por uno
                                let imported = 0;
                                let failed = 0;
                                const importErrors = []; // Errores durante la importación
                                
                                const importNext = (index) => {
                                    if (index >= productsToImport.length) {
                                        // Mostrar resumen detallado
                                        let message = `Importación completada:\n\n✅ Importados: ${imported}\n❌ Fallidos: ${failed}`;
                                        
                                        // Agregar resumen de productos que no se importaron
                                        if (duplicateCount > 0 || skippedCount > 0 || failedProducts.length > 0) {
                                            message += `\n\n📋 Productos NO importados:`;
                                            if (duplicateCount > 0) {
                                                message += `\n\n🔄 Duplicados (${duplicateCount}):`;
                                                const duplicates = failedProducts.filter(p => p.razon.includes('duplicado'));
                                                duplicates.slice(0, 10).forEach(p => {
                                                    message += `\n  • PLACA: ${p.placa} | EQUIPO: ${p.equipo}`;
                                                });
                                                if (duplicates.length > 10) {
                                                    message += `\n  ... y ${duplicates.length - 10} más`;
                                                }
                                            }
                                            if (skippedCount > 0) {
                                                message += `\n\n📍 Sitio no encontrado (${skippedCount}):`;
                                                const sitioErrors = failedProducts.filter(p => p.razon.includes('Sitio no encontrado'));
                                                sitioErrors.slice(0, 10).forEach(p => {
                                                    message += `\n  • PLACA: ${p.placa} | EQUIPO: ${p.equipo} | Lugar: ${p.lugar}`;
                                                });
                                                if (sitioErrors.length > 10) {
                                                    message += `\n  ... y ${sitioErrors.length - 10} más`;
                                                }
                                            }
                                            // Otros errores
                                            const otrosErrores = failedProducts.filter(p => 
                                                !p.razon.includes('duplicado') && !p.razon.includes('Sitio no encontrado')
                                            );
                                            if (otrosErrores.length > 0) {
                                                message += `\n\n⚠️ Otros errores (${otrosErrores.length}):`;
                                                otrosErrores.slice(0, 10).forEach(p => {
                                                    message += `\n  • PLACA: ${p.placa} | EQUIPO: ${p.equipo} | Razón: ${p.razon}`;
                                                });
                                                if (otrosErrores.length > 10) {
                                                    message += `\n  ... y ${otrosErrores.length - 10} más`;
                                                }
                                            }
                                        }
                                        
                                        // Errores durante la importación
                                        if (importErrors.length > 0) {
                                            message += `\n\n❌ Errores durante importación (${importErrors.length}):`;
                                            importErrors.slice(0, 10).forEach(err => {
                                                message += `\n  • ${err}`;
                                            });
                                            if (importErrors.length > 10) {
                                                message += `\n  ... y ${importErrors.length - 10} más`;
                                            }
                                        }
                                        
                                        alert(message);
                                        // Recargar productos
                                        if (window.app && window.app.loadProducts) {
                                            window.app.loadProducts();
                                        }
                                        return;
                                    }
                                    
                                    const product = productsToImport[index];
                                    
                                    fetch('/api/products', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify(product)
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            imported++;
                                        } else {
                                            failed++;
                                            importErrors.push(`PLACA: ${product.barcode} | EQUIPO: ${product.name} | Error: ${data.message || data.error || 'Error desconocido'}`);
                                        }
                                        // Continuar con el siguiente
                                        importNext(index + 1);
                                    })
                                    .catch(error => {
                                        failed++;
                                        importErrors.push(`PLACA: ${product.barcode} | EQUIPO: ${product.name} | Error: ${error.message}`);
                                        // Continuar con el siguiente
                                        importNext(index + 1);
                                    });
                                };
                                
                                // Iniciar importación
                                importNext(0);
                                
                            } catch (error) {
                                console.error('Error al leer Excel:', error);
                                alert('Error al leer el archivo Excel: ' + error.message);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    };
                    input.click();
                },

                async downloadExcel(data, filename) {
                    try {
                        // Mostrar mensaje de carga
                        const loadingMessage = document.createElement('div');
                        loadingMessage.className = 'alert alert-info alert-dismissible fade show position-fixed';
                        loadingMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        loadingMessage.innerHTML = `
                            <strong>Generando Excel...</strong> Por favor espera.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(loadingMessage);
                        
                        // Enviar datos al servidor para generar el Excel
                        const response = await fetch('/export_excel.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include', // Incluir cookies de sesión
                            body: JSON.stringify({
                                data: data,
                                filename: filename
                            })
                        });
                        
                        // Remover mensaje de carga
                        if (loadingMessage.parentNode) {
                            loadingMessage.parentNode.removeChild(loadingMessage);
                        }
                        
                        // Verificar el tipo de contenido de la respuesta
                        const contentType = response.headers.get('content-type');
                        
                        if (!response.ok || (contentType && contentType.includes('application/json'))) {
                            // Es un error, leer como JSON
                            const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));
                            throw new Error(errorData.error || `Error HTTP: ${response.status}`);
                        }
                        
                        // Obtener el blob del archivo Excel
                        const blob = await response.blob();
                        
                        // Crear URL y descargar
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                        
                        // Mostrar mensaje de éxito
                        const successMessage = document.createElement('div');
                        successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        successMessage.innerHTML = `
                            <strong>¡Éxito!</strong> Archivo Excel exportado correctamente.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(successMessage);
                        
                        setTimeout(() => {
                            if (successMessage.parentNode) {
                                successMessage.parentNode.removeChild(successMessage);
                            }
                        }, 5000);
                        
                    } catch (error) {
                        console.error('Error al exportar a Excel:', error);
                        
                        // Remover mensaje de carga si existe
                        const loadingMessages = document.querySelectorAll('.alert-info');
                        loadingMessages.forEach(msg => {
                            if (msg.parentNode) {
                                msg.parentNode.removeChild(msg);
                            }
                        });
                        
                        // Mostrar mensaje de error
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                        errorMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                        errorMessage.innerHTML = `
                            <strong>Error:</strong> ${error.message || 'Error al exportar a Excel'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(errorMessage);
                        
                        setTimeout(() => {
                            if (errorMessage.parentNode) {
                                errorMessage.parentNode.removeChild(errorMessage);
                            }
                        }, 8000);
                    }
                },

                viewProduct(product) {
                    console.log('View product:', product);
                    // Implementar modal de visualización
                },

                deleteProduct(productOrId) {
                    let targetProduct = null;
                    
                    if (productOrId && typeof productOrId === 'object') {
                        targetProduct = productOrId;
                    } else {
                        targetProduct = this.products.find(p => p.id == productOrId)
                            || this.filteredProducts.find(p => p.id == productOrId)
                            || this.filteredInventory.find(p => p.id == productOrId);
                    }
                    
                    const productId = targetProduct ? targetProduct.id : productOrId;
                    const productName = targetProduct ? targetProduct.name || 'este producto' : 'este producto';
                    
                    if (!productId) {
                        alert('No se pudo determinar el producto a eliminar.');
                        return;
                    }
                    
                    if (confirm(`¿Estás seguro de eliminar el producto "${productName}"?`)) {
                        window.deleteProduct(productId);
                    }
                },
                goToLogin() {
                    console.log('🔐 Redirigiendo al login...');
                    window.location.href = '/login.php';
                },
                navigateToPHP(path) {
                    // Verificar que el usuario esté autenticado y tenga permisos
                    if (!this.user || this.user.role === 'guest') {
                        alert('Debes iniciar sesión para acceder a esta página');
                        window.location.href = '/login.php';
                        return;
                    }
                    
                    // Navegar a la página PHP
                    window.location.href = '/' + path;
                },
                
                setView(view) {
                    this.currentView = view;
                    if (view === 'products') {
                        this.loadProducts();
                    } else if (view === 'existing-equipment') {
                        this.loadProducts(); // Cargar productos para actualizar equipos existentes
                    }
                }
            },
            computed: {
                uniqueDepartments() {
                    const departments = this.existingEquipment
                        .map(product => product.department)
                        .filter(dept => dept && dept.trim() !== '');
                    return [...new Set(departments)].sort();
                },
                uniqueSitesDepartments() {
                    const departments = this.sites
                        .map(product => product.department)
                        .filter(dept => dept && dept.trim() !== '');
                    return [...new Set(departments)].sort();
                }
            }
        }).mount('#app');
        
        // Hacer la instancia de Vue disponible globalmente
        // En Vue 3, necesitamos acceder al componente raíz
        setTimeout(() => {
            const appElement = document.querySelector('#app');
            if (appElement && appElement._vnode && appElement._vnode.component) {
                window.app = appElement._vnode.component.ctx;
                console.log('Vue app montado correctamente en window.app');
            } else {
                console.warn('No se pudo acceder a la instancia de Vue - window.app puede no funcionar');
                // Fallback: usar el elemento directamente
                window.app = appElement;
            }
        }, 100);
        
        // CONTROL DE NAVEGACIÓN DEL NAVEGADOR (botones atrás/adelante)
        window.addEventListener('popstate', function(event) {
            console.log('Navegación del navegador detectada:', window.location.pathname);
            
            // Si el usuario está logueado y trata de ir al login, redirigir al dashboard
            if (window.location.pathname === '/login.php' && window.app && window.app.user && window.app.user.role !== 'guest') {
                console.log('Usuario logueado intentando ir al login - redirigiendo al dashboard');
                window.history.pushState(null, '', '/');
                return;
            }
            
            // Si el usuario no está logueado y trata de ir al dashboard, redirigir al login
            if (window.location.pathname === '/' && window.app && window.app.user && window.app.user.role === 'guest') {
                console.log('Usuario no logueado intentando ir al dashboard - redirigiendo al login');
                window.history.pushState(null, '', '/login.php');
                window.location.href = '/login.php';
                return;
            }
        });
        
        // Prevenir navegación directa al login si ya está logueado
        if (window.location.pathname === '/login.php') {
            // Verificar sesión antes de mostrar la página
            fetch('/auth/me')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.authenticated) {
                        console.log('Usuario ya logueado - redirigiendo al dashboard');
                        window.location.href = '/';
                    }
                })
                .catch(err => {
                    console.log('Error verificando sesión:', err);
                });
        }
    </script>

    <!-- JavaScript vanilla para el modal -->
    <script>
        function openModal() {
            console.log('openModal called');
            
            // Generar SKU único automáticamente
            const autoSKU = generateUniqueSKU();
            document.getElementById('productSku').value = autoSKU;
            
            // Auto-rellenar código de barras basado en el SKU generado
            document.getElementById('productBarcode').value = 'INV-' + autoSKU;
            
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                console.log('Modal opened with auto-generated SKU:', autoSKU);
            } else {
                console.error('Modal not found');
            }
        }

        function closeModal() {
            console.log('closeModal called');
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                console.log('Modal closed');
            }
        }

        function openModalForExistingEquipment() {
            console.log('openModalForExistingEquipment called');
            
            // Limpiar el formulario
            document.getElementById('existingEquipmentForm').reset();
            
            // Abrir el modal usando Bootstrap
            const modalElement = document.getElementById('addExistingEquipmentModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
                modalInstance.show();
            } else {
                console.error('Modal addExistingEquipmentModal not found');
            }
        }

        function closeExistingEquipmentModal() {
            console.log('closeExistingEquipmentModal called');
            const modalElement = document.getElementById('addExistingEquipmentModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            // Limpiar foto preview
            clearExistingEquipmentPhotoPreview();
            // Limpiar el formulario al cerrar
            document.getElementById('existingEquipmentForm').reset();
            // Resetear opciones del select de departamento
            const departmentSelect = document.getElementById('existingEquipmentDepartment');
            if (departmentSelect) {
                departmentSelect.innerHTML = '<option value="">Primero selecciona el tipo de ubicación</option>';
            }
        }
        
        function updateDepartmentOptions() {
            const locationType = document.getElementById('existingEquipmentLocationType').value;
            const departmentSelect = document.getElementById('existingEquipmentDepartment');
            
            if (!departmentSelect) return;
            
            // Limpiar opciones actuales
            departmentSelect.innerHTML = '';
            
            if (!locationType) {
                departmentSelect.innerHTML = '<option value="">Primero selecciona el tipo de ubicación</option>';
                return;
            }
            
            // Agregar opción por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccionar ' + (locationType === 'departamento' ? 'departamento' : 'sitio');
            departmentSelect.appendChild(defaultOption);
            
            if (locationType === 'departamento') {
                // Lista de Departamentos
                const departments = [
                    'TELEMATICA',
                    'S-1',
                    'S-3',
                    'DOA',
                    'CAI',
                    'ARMERIA CENTRAL',
                    'ARMERIA PALACIO',
                    'TRANSPORTE'
                ];
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });
            } else if (locationType === 'sitio') {
                // Lista de Sitios
                const sites = [
                    'Cerro Ancón',
                    'Edificio Pradera',
                    'Cerro Oscuro',
                    'Palacio',
                    'Cerro Galera',
                    'Cerro Santa Rita',
                    'Cerro Jefe',
                    'Cerro Buenos Aires Chepo',
                    'Aguas Frías',
                    'Cerro Mena',
                    'Cerro La Silla',
                    'Cerro Taboga',
                    'Cerro Canajagua',
                    'Cerro Peña',
                    'Cerro Boca Viento',
                    'Cerro Zancudo',
                    'Meseta de Chorcha'
                ];
                
                sites.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site;
                    option.textContent = site;
                    departmentSelect.appendChild(option);
                });
            }
        }

        function saveExistingEquipment() {
            console.log('saveExistingEquipment called');
            
            // Validar el formulario
            const form = document.getElementById('existingEquipmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Validar campos con patrones específicos
            const description = document.getElementById('existingEquipmentDescription').value.trim();
            if (description && !/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(description)) {
                alert('La descripción solo puede contener letras');
                return;
            }
            
            const locationType = document.getElementById('existingEquipmentLocationType').value;
            if (!locationType) {
                alert('Por favor selecciona el tipo de ubicación (Departamento o Sitio)');
                return;
            }
            
            const department = document.getElementById('existingEquipmentDepartment').value.trim();
            if (!department) {
                alert('Por favor selecciona un ' + (locationType === 'departamento' ? 'departamento' : 'sitio'));
                return;
            }
            
            const brand = document.getElementById('existingEquipmentBrand').value.trim();
            if (brand && !/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(brand)) {
                alert('La marca solo puede contener letras');
                return;
            }
            
            // Generar SKU único automáticamente
            const autoSKU = generateUniqueSKU();
            
            // Generar marbete único basado en el serial o SKU
            const serial = document.getElementById('existingEquipmentSerial').value.trim();
            const label = serial || autoSKU;
            
            // Construir descripción completa con specs y sub_specs
            const specs = document.getElementById('existingEquipmentSpecs').value.trim();
            const subSpecs = document.getElementById('existingEquipmentSubSpecs').value.trim();
            let fullDescription = description;
            if (specs || subSpecs) {
                const specsText = [];
                if (specs) specsText.push(`Especificaciones/EXT: ${specs}`);
                if (subSpecs) specsText.push(`Sub-Especific: ${subSpecs}`);
                if (fullDescription) {
                    fullDescription = `${fullDescription}\n${specsText.join('\n')}`;
                } else {
                    fullDescription = specsText.join('\n');
                }
            }
            
            // Mapear estado del formulario al formato del backend
            const statusMap = {
                'operativo': 'active',
                'criterio_tecnico': 'maintenance',
                'descarte': 'inactive'
            };
            const formStatus = document.getElementById('existingEquipmentStatus').value;
            const mappedStatus = statusMap[formStatus] || 'active';
            
            // Obtener photo_url si se subió una foto
            const photoInput = document.getElementById('existingEquipmentPhoto');
            const photoUrl = photoInput && photoInput.dataset.uploadedPhotoUrl ? photoInput.dataset.uploadedPhotoUrl : null;
            
            // Mapear datos del formulario al formato que espera el backend
            const productData = {
                sku: autoSKU,
                name: brand && document.getElementById('existingEquipmentModel').value.trim() 
                    ? `${brand} ${document.getElementById('existingEquipmentModel').value.trim()}`.trim()
                    : brand || document.getElementById('existingEquipmentModel').value.trim() || 'Equipo Existente',
                description: fullDescription || '',
                brand: brand || '',
                model: document.getElementById('existingEquipmentModel').value.trim() || '',
                serial_number: serial || autoSKU,
                department: department,
                label: label,
                barcode: document.getElementById('existingEquipmentNumericAssign').value.trim() || `INV-${autoSKU}`,
                stock_quantity: parseInt(document.getElementById('existingEquipmentQuantity').value, 10) || 1,
                price: 0,
                cost: 0,
                category_id: 1, // Por defecto
                supplier_id: 1, // Por defecto
                type: 'existing_equipment', // Identificador para equipos existentes
                status: mappedStatus,
                photo_url: photoUrl // Incluir URL de la foto si existe
            };
            
            console.log('Datos del equipo existente a guardar:', productData);
            
            // Validar campos requeridos
            if (!productData.serial_number || !productData.label) {
                alert('Error: No se pudo generar el serial o marbete. Por favor intente nuevamente.');
                return;
            }
            
            // Enviar datos al servidor
            fetch('/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(async response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                // Obtener el texto de la respuesta primero para debugging
                const responseText = await response.text();
                console.log('Response text length:', responseText.length);
                console.log('Response text:', responseText);
                
                // Verificar si la respuesta está vacía
                if (!responseText || responseText.trim() === '') {
                    throw new Error(`El servidor devolvió una respuesta vacía (status: ${response.status}). Verifica la conexión con la base de datos y la configuración del servidor.`);
                }
                
                if (!response.ok) {
                    // Intentar parsear como JSON si es posible
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error || errorMessage;
                        } else {
                            // Si no es JSON, verificar si es HTML
                            if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                                errorMessage += ': El servidor devolvió HTML en lugar de JSON. Verifica que estés accediendo a través de index.php';
                            } else if (responseText.length < 200) {
                                errorMessage += ': ' + responseText;
                            }
                        }
                    } catch (e) {
                        // Si no es JSON, usar el texto de la respuesta
                        if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                            errorMessage += ': El servidor devolvió HTML en lugar de JSON. Verifica que estés accediendo a través de index.php';
                        } else if (responseText && responseText.length < 200) {
                            errorMessage += ': ' + responseText;
                        } else {
                            errorMessage += ': Respuesta no válida del servidor';
                        }
                    }
                    throw new Error(errorMessage);
                }
                
                // Verificar que la respuesta sea JSON válido antes de parsear
                const trimmedText = responseText.trim();
                if (!trimmedText.startsWith('{') && !trimmedText.startsWith('[')) {
                    if (trimmedText.includes('<!DOCTYPE') || trimmedText.includes('<html')) {
                        throw new Error('El servidor devolvió HTML en lugar de JSON. Verifica que estés accediendo a través de index.php y que el servidor esté configurado correctamente.');
                    }
                    throw new Error('El servidor no devolvió JSON válido. Respuesta: ' + trimmedText.substring(0, 200));
                }
                
                // Intentar parsear como JSON
                try {
                    const parsedData = JSON.parse(responseText);
                    return parsedData;
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    console.error('Response text that failed to parse:', responseText.substring(0, 500));
                    throw new Error('Error al parsear la respuesta JSON del servidor. Verifica que el servidor esté funcionando correctamente.');
                }
            })
            .then(data => {
                console.log('Success:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Equipo existente guardado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    // Cerrar el modal
                    closeExistingEquipmentModal();
                    
                    // Recargar productos
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    }
                } else {
                    // Mostrar mensaje de error
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                    errorMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    errorMessage.innerHTML = `
                        <strong>Error:</strong> ${data.error || 'Error desconocido'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(errorMessage);
                    
                    setTimeout(() => {
                        if (errorMessage.parentNode) {
                            errorMessage.parentNode.removeChild(errorMessage);
                        }
                    }, 8000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = error.message;
                
                // Mensaje más específico para error 405
                if (errorMessage.includes('405')) {
                    errorMessage = 'Error 405: Método no permitido. Esto generalmente ocurre cuando se accede directamente a index.html en lugar de index.php. Por favor, asegúrate de acceder a la aplicación a través de index.php o usa un servidor PHP local.';
                }
                
                // Mostrar mensaje de error más visible
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px;';
                errorAlert.innerHTML = `
                    <strong>Error al guardar:</strong><br>
                    ${errorMessage}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(errorAlert);
                
                setTimeout(() => {
                    if (errorAlert.parentNode) {
                        errorAlert.parentNode.removeChild(errorAlert);
                    }
                }, 10000);
            });
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const addModal = document.getElementById('addProductModal');
            const editModal = document.getElementById('editProductModal');
            const existingEquipmentModal = document.getElementById('addExistingEquipmentModal');
            
            if (event.target === addModal) {
                closeModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === existingEquipmentModal) {
                closeExistingEquipmentModal();
            }
        }

        function generateBarcode() {
            const sku = document.getElementById('productSku').value;
            const name = document.getElementById('productName').value;
            const barcodeField = document.getElementById('productBarcode');
            
            let barcode = '';
            if (sku) {
                barcode = 'INV-' + sku.toUpperCase();
            } else if (name) {
                barcode = 'INV-' + name.substring(0, 10).replace(/\s+/g, '-').toUpperCase();
            } else {
                barcode = 'INV-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            }
            
            barcodeField.value = barcode;
        }

        function generateUniqueSKU() {
            // Obtener productos existentes desde Vue.js data
            let existingProducts = [];
            try {
                // Intentar obtener productos desde la instancia de Vue global
                if (window.app && window.app.products) {
                    existingProducts = window.app.products.map(p => ({sku: p.sku}));
                }
            } catch (e) {
                console.log('No se pudo obtener productos de Vue, usando lista por defecto');
            }
            
            // Lista de respaldo con productos existentes conocidos
            const fallbackProducts = [
                {sku: 'RES-1K-001'},
                {sku: 'CAP-100U-001'},
                {sku: 'LED-RED-001'},
                {sku: 'CAB-USB-001'},
                {sku: 'RES-10K-001'}
            ];
            
            if (existingProducts.length === 0) {
                existingProducts = fallbackProducts;
            }
            
            let attempts = 0;
            let newSKU;
            
            do {
                // Generar SKU basado en timestamp y número aleatorio
                const timestamp = Date.now().toString().slice(-6);
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                newSKU = 'PRD-' + timestamp + '-' + randomNum;
                attempts++;
                
                // Si después de 10 intentos no encuentra uno único, usar timestamp completo
                if (attempts > 10) {
                    newSKU = 'PRD-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                    break;
                }
            } while (existingProducts.some(p => p.sku.toLowerCase() === newSKU.toLowerCase()));
            
            console.log('SKU generado:', newSKU, 'después de', attempts, 'intentos');
            return newSKU;
        }

        function autoFillFields() {
            const sku = document.getElementById('productSku').value.trim();
            
            // Solo auto-rellenar Código de Barras basado en SKU
            if (sku && !document.getElementById('productBarcode').value) {
                document.getElementById('productBarcode').value = 'INV-' + sku.toUpperCase();
            }
        }

        function saveProduct() {
            console.log('saveProduct called');
            
            // Recopilar datos del formulario
            const productData = {
                sku: document.getElementById('productSku').value,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                model: document.getElementById('productModel').value,
                description: document.getElementById('productDescription').value,
                category_id: parseInt(document.getElementById('productCategory').value) || 1,
                supplier_id: parseInt(document.getElementById('productSupplier').value) || 1,
                type: document.getElementById('productType').value,
                serial_number: document.getElementById('productSerial').value,
                department: document.getElementById('productDepartment').value,
                label: document.getElementById('productLabel').value,
                barcode: document.getElementById('productBarcode').value,
                cost: parseFloat(document.getElementById('productCost').value) || 0,
                price: parseFloat(document.getElementById('productPrice').value) || 0,
                stock_quantity: parseInt(document.getElementById('productStock').value) || 0,
                min_stock_level: parseInt(document.getElementById('productMinStock').value) || 0,
                max_stock_level: parseInt(document.getElementById('productMaxStock').value) || 0,
                expiration_date: document.getElementById('productExpiration').value || null,
                status: document.getElementById('productStatus').value || 'active'
            };
            
            console.log('Product data:', productData);
            
            // Validar campos requeridos
            if (!productData.sku || !productData.name || !productData.serial_number || !productData.label || !productData.type) {
                alert('Por favor completa todos los campos requeridos (SKU, Nombre, Serial, Marbete, Tipo)');
                return;
            }
            
            // Campos opcionales pueden quedar en blanco
            console.log('Creando producto con campos opcionales:', {
                department: productData.department,
                brand: productData.brand,
                model: productData.model,
                description: productData.description
            });
            
            // Validar campos únicos (simulación con datos existentes)
            const existingProducts = [
                {sku: 'RES-1K-001', serial_number: 'RES001-2024-001', label: 'RES-1K-001'},
                {sku: 'CAP-100U-001', serial_number: 'CAP001-2024-001', label: 'CAP-100U-001'},
                {sku: 'LED-RED-001', serial_number: 'LED001-2024-001', label: 'LED-RED-001'}
            ];
            
            // Verificar SKU único
            if (existingProducts.some(p => p.sku.toLowerCase() === productData.sku.toLowerCase())) {
                alert('El SKU ya existe. Por favor usa un SKU diferente.');
                return;
            }
            
            // Verificar Serial único
            if (existingProducts.some(p => p.serial_number.toLowerCase() === productData.serial_number.toLowerCase())) {
                alert('El número de serial ya existe. Por favor usa un serial diferente.');
                return;
            }
            
            // Verificar Marbete único
            if (existingProducts.some(p => p.label.toLowerCase() === productData.label.toLowerCase())) {
                alert('El marbete ya existe. Por favor usa un marbete diferente.');
                return;
            }
            
            // Enviar datos al servidor
            fetch('/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.text().then(text => {
                    console.log('Raw response:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('Response text:', text);
                        throw new Error('El servidor no devolvió JSON válido: ' + text.substring(0, 100));
                    }
                });
            })
            .then(data => {
                console.log('Success:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito más visible
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto guardado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    closeModal();
                    clearForm();
                    
                    // Recargar productos en lugar de la página completa
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    }
                } else {
                    alert('Error del servidor: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar el producto: ' + error.message);
            });
        }

        function clearForm() {
            // Limpiar todos los campos del formulario excepto SKU (se genera automáticamente)
            document.getElementById('productName').value = '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productModel').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productSupplier').value = '';
            document.getElementById('productType').value = '';
            document.getElementById('productSerial').value = '';
            document.getElementById('productDepartment').value = '';
            document.getElementById('productLabel').value = '';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productMinStock').value = '';
            document.getElementById('productMaxStock').value = '';
            document.getElementById('productExpiration').value = '';
            document.getElementById('productStatus').value = 'active';
        }

        // Variables y utilidades globales para edición
        let currentEditProductId = null;

        function resolveProduct(productOrId) {
            if (!productOrId) {
                return null;
            }

            if (typeof productOrId === 'object') {
                return productOrId;
            }

            const id = parseInt(productOrId, 10);
            if (Number.isNaN(id)) {
                return null;
            }

            if (window.app && Array.isArray(window.app.products)) {
                const fromProducts = window.app.products.find(p => p.id == id);
                if (fromProducts) {
                    return fromProducts;
                }
            }

            if (window.app && Array.isArray(window.app.filteredProducts)) {
                const fromFiltered = window.app.filteredProducts.find(p => p.id == id);
                if (fromFiltered) {
                    return fromFiltered;
                }
            }

            if (window.app && Array.isArray(window.app.filteredInventory)) {
                const fromInventory = window.app.filteredInventory.find(p => p.id == id);
                if (fromInventory) {
                    return fromInventory;
                }
            }

            return null;
        }

        function openEditModalWithProduct(product) {
            if (!product) {
                return;
            }

            fillEditForm(product);
            const modalElement = document.getElementById('editProductModal');
            if (!modalElement) {
                console.error('openEditModalWithProduct: modal no encontrado');
                return;
            }

            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
            modalInstance.show();
        }

        function editProduct(productOrId) {
            const product = resolveProduct(productOrId);

            if (product) {
                openEditModalWithProduct(product);
                return;
            }

                console.log('Producto no encontrado en memoria, cargando desde servidor...');
                fetch('/products')
                    .then(response => response.json())
                    .then(data => {
                    if (data.success && Array.isArray(data.data)) {
                        const foundProduct = data.data.find(p => p.id == productOrId);
                            if (foundProduct) {
                            openEditModalWithProduct(foundProduct);
                            } else {
                                alert('Producto no encontrado');
                            }
                        } else {
                            alert('Error al cargar productos');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al cargar productos');
                    });
        }

        function ensureSelectValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (!select) {
                return;
            }
            
            if (value === null || value === undefined || value === '') {
                select.value = '';
                return;
            }

            const exists = Array.from(select.options).some(option => option.value == value);
            if (!exists) {
                const newOption = new Option(value, value, true, true);
                select.add(newOption);
            } else {
                select.value = value;
            }
        }

        function fillEditForm(product) {
            currentEditProductId = product.id;
            
            const assignValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value ?? '';
                }
            };

            assignValue('editProductSku', product.sku);
            assignValue('editProductName', product.name);
            assignValue('editProductBrand', product.brand);
            assignValue('editProductModel', product.model);
            assignValue('editProductSerial', product.serial_number);
            assignValue('editProductLabel', product.label);
            assignValue('editProductPrice', product.price);
            assignValue('editProductStock', product.stock_quantity);
            assignValue('editProductDescription', product.description);
            assignValue('editProductBarcode', product.barcode);
            assignValue('editProductStatus', product.status || 'active');

            ensureSelectValue('editProductCategory', product.category_id ?? '1');
            ensureSelectValue('editProductSupplier', product.supplier_id ?? '1');
            ensureSelectValue('editProductType', product.type || 'computo');
            ensureSelectValue('editProductDepartment', product.department || '');
            
            // Manejar foto del producto
            const photoInput = document.getElementById('editProductPhoto');
            const photoPreview = document.getElementById('editProductPhotoPreview');
            const photoPreviewImg = document.getElementById('editProductPhotoPreviewImg');
            const photoCurrent = document.getElementById('editProductPhotoCurrent');
            const photoCurrentImg = document.getElementById('editProductPhotoCurrentImg');
            
            // Limpiar previews anteriores
            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.style.display = 'none';
            if (photoCurrent) photoCurrent.style.display = 'none';
            
            // Mostrar foto actual si existe
            if (product.photo_url) {
                if (photoCurrent && photoCurrentImg) {
                    photoCurrentImg.src = product.photo_url;
                    photoCurrent.style.display = 'block';
                }
            }
            
            // Guardar photo_url actual para no perderla si no se sube nueva foto
            if (photoInput) {
                photoInput.dataset.currentPhotoUrl = product.photo_url || '';
            }
        }

        function closeEditModal() {
            console.log('closeEditModal called');
            const modalElement = document.getElementById('editProductModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement) || bootstrap.Modal.getOrCreateInstance(modalElement);
                modalInstance.hide();
            }
            currentEditProductId = null;
            
            // Limpiar foto preview
            clearPhotoPreview();
        }
        
        // Funciones para manejar fotos
        function capturePhoto() {
            const photoInput = document.getElementById('editProductPhoto');
            if (photoInput) {
                photoInput.click();
            }
        }
        
        function clearPhotoPreview() {
            const photoInput = document.getElementById('editProductPhoto');
            const photoPreview = document.getElementById('editProductPhotoPreview');
            if (photoInput) {
                photoInput.value = '';
                photoInput.dataset.uploadedPhotoUrl = '';
            }
            if (photoPreview) {
                photoPreview.style.display = 'none';
            }
        }
        
        // Event listener para cuando se seleccione un archivo
        document.addEventListener('DOMContentLoaded', function() {
            // Para el formulario de edición
            const photoInput = document.getElementById('editProductPhoto');
            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Mostrar preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const photoPreview = document.getElementById('editProductPhotoPreview');
                            const photoPreviewImg = document.getElementById('editProductPhotoPreviewImg');
                            if (photoPreview && photoPreviewImg) {
                                photoPreviewImg.src = e.target.result;
                                photoPreview.style.display = 'block';
                            }
                            
                            // Subir la foto automáticamente
                            uploadPhoto(file);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Para el formulario de agregar equipo existente
            const existingPhotoInput = document.getElementById('existingEquipmentPhoto');
            if (existingPhotoInput) {
                existingPhotoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Mostrar preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const photoPreview = document.getElementById('existingEquipmentPhotoPreview');
                            const photoPreviewImg = document.getElementById('existingEquipmentPhotoPreviewImg');
                            if (photoPreview && photoPreviewImg) {
                                photoPreviewImg.src = e.target.result;
                                photoPreview.style.display = 'block';
                            }
                            
                            // Subir la foto automáticamente
                            uploadExistingEquipmentPhoto(file);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
        
        function uploadPhoto(file) {
            const formData = new FormData();
            formData.append('photo', file);
            
            // Mostrar indicador de carga
            const photoInput = document.getElementById('editProductPhoto');
            if (photoInput) {
                photoInput.disabled = true;
            }
            
            fetch('/upload-photo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Guardar la URL de la foto subida
                    if (photoInput) {
                        photoInput.dataset.uploadedPhotoUrl = data.photo_url;
                        photoInput.disabled = false;
                    }
                    console.log('Foto subida exitosamente:', data.photo_url);
                } else {
                    alert('Error al subir la foto: ' + (data.error || 'Error desconocido'));
                    if (photoInput) {
                        photoInput.disabled = false;
                        clearPhotoPreview();
                    }
                }
            })
            .catch(error => {
                console.error('Error al subir foto:', error);
                alert('Error al subir la foto: ' + error.message);
                if (photoInput) {
                    photoInput.disabled = false;
                    clearPhotoPreview();
                }
            });
        }
        
        // Funciones para el formulario de agregar equipo existente
        function captureExistingEquipmentPhoto() {
            // Verificar si el navegador soporta la API de cámara
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Intentar acceder a la cámara
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Cámara trasera en móviles
                    } 
                })
                .then(function(stream) {
                    // Crear modal para mostrar la cámara
                    showCameraModal(stream, 'existingEquipment');
                })
                .catch(function(error) {
                    console.error('Error al acceder a la cámara:', error);
                    // Si falla, usar el método tradicional (selector de archivos)
                    const photoInput = document.getElementById('existingEquipmentPhoto');
                    if (photoInput) {
                        photoInput.click();
                    }
                });
            } else {
                // Si no hay soporte, usar el método tradicional
                const photoInput = document.getElementById('existingEquipmentPhoto');
                if (photoInput) {
                    photoInput.click();
                }
            }
        }
        
        function capturePhoto() {
            // Verificar si el navegador soporta la API de cámara
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Intentar acceder a la cámara
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Cámara trasera en móviles
                    } 
                })
                .then(function(stream) {
                    // Crear modal para mostrar la cámara
                    showCameraModal(stream, 'editProduct');
                })
                .catch(function(error) {
                    console.error('Error al acceder a la cámara:', error);
                    // Si falla, usar el método tradicional (selector de archivos)
                    const photoInput = document.getElementById('editProductPhoto');
                    if (photoInput) {
                        photoInput.click();
                    }
                });
            } else {
                // Si no hay soporte, usar el método tradicional
                const photoInput = document.getElementById('editProductPhoto');
                if (photoInput) {
                    photoInput.click();
                }
            }
        }
        
        function showCameraModal(stream, formType) {
            // Crear modal para la cámara
            const cameraModal = document.createElement('div');
            cameraModal.className = 'modal fade';
            cameraModal.id = 'cameraModal';
            cameraModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Tomar Foto</h5>
                            <button type="button" class="btn-close" onclick="closeCameraModal()"></button>
                        </div>
                        <div class="modal-body text-center">
                            <video id="cameraVideo" autoplay playsinline style="width: 100%; max-width: 500px; border-radius: 8px;"></video>
                            <canvas id="cameraCanvas" style="display: none;"></canvas>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-secondary" onclick="closeCameraModal()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="takePicture('${formType}')">
                                <i class="fas fa-camera"></i> Capturar Foto
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(cameraModal);
            
            const modal = new bootstrap.Modal(cameraModal);
            modal.show();
            
            // Mostrar el stream de video
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;
            
            // Guardar el stream para poder detenerlo después
            cameraModal.dataset.stream = JSON.stringify({});
            window.currentCameraStream = stream;
            
            // Limpiar cuando se cierre el modal
            cameraModal.addEventListener('hidden.bs.modal', function() {
                if (window.currentCameraStream) {
                    window.currentCameraStream.getTracks().forEach(track => track.stop());
                    window.currentCameraStream = null;
                }
                document.body.removeChild(cameraModal);
            });
        }
        
        function takePicture(formType) {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Ajustar el canvas al tamaño del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Capturar el frame actual
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convertir a blob
            canvas.toBlob(function(blob) {
                // Detener la cámara
                if (window.currentCameraStream) {
                    window.currentCameraStream.getTracks().forEach(track => track.stop());
                    window.currentCameraStream = null;
                }
                
                // Cerrar el modal
                const cameraModal = document.getElementById('cameraModal');
                const modal = bootstrap.Modal.getInstance(cameraModal);
                modal.hide();
                
                // Crear un archivo desde el blob
                const file = new File([blob], 'camera-photo-' + Date.now() + '.jpg', { type: 'image/jpeg' });
                
                // Procesar según el tipo de formulario
                if (formType === 'existingEquipment') {
                    processCameraPhoto(file, 'existingEquipment');
                } else {
                    processCameraPhoto(file, 'editProduct');
                }
            }, 'image/jpeg', 0.9);
        }
        
        function processCameraPhoto(file, formType) {
            // Mostrar preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById(formType === 'existingEquipment' ? 'existingEquipmentPhotoPreview' : 'editProductPhotoPreview');
                const photoPreviewImg = document.getElementById(formType === 'existingEquipment' ? 'existingEquipmentPhotoPreviewImg' : 'editProductPhotoPreviewImg');
                if (photoPreview && photoPreviewImg) {
                    photoPreviewImg.src = e.target.result;
                    photoPreview.style.display = 'block';
                }
                
                // Subir la foto automáticamente
                if (formType === 'existingEquipment') {
                    uploadExistingEquipmentPhoto(file);
                } else {
                    uploadPhoto(file);
                }
            };
            reader.readAsDataURL(file);
        }
        
        function closeCameraModal() {
            // Detener la cámara
            if (window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            
            // Cerrar el modal
            const cameraModal = document.getElementById('cameraModal');
            if (cameraModal) {
                const modal = bootstrap.Modal.getInstance(cameraModal);
                if (modal) {
                    modal.hide();
                }
            }
        }
        
        function clearExistingEquipmentPhotoPreview() {
            const photoInput = document.getElementById('existingEquipmentPhoto');
            const photoPreview = document.getElementById('existingEquipmentPhotoPreview');
            if (photoInput) {
                photoInput.value = '';
                photoInput.dataset.uploadedPhotoUrl = '';
            }
            if (photoPreview) {
                photoPreview.style.display = 'none';
            }
        }
        
        function uploadExistingEquipmentPhoto(file) {
            const formData = new FormData();
            formData.append('photo', file);
            
            // Mostrar indicador de carga
            const photoInput = document.getElementById('existingEquipmentPhoto');
            if (photoInput) {
                photoInput.disabled = true;
            }
            
            fetch('/upload-photo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Guardar la URL de la foto subida
                    if (photoInput) {
                        photoInput.dataset.uploadedPhotoUrl = data.photo_url;
                        photoInput.disabled = false;
                    }
                    console.log('Foto subida exitosamente:', data.photo_url);
                } else {
                    alert('Error al subir la foto: ' + (data.error || 'Error desconocido'));
                    if (photoInput) {
                        photoInput.disabled = false;
                        clearExistingEquipmentPhotoPreview();
                    }
                }
            })
            .catch(error => {
                console.error('Error al subir foto:', error);
                alert('Error al subir la foto: ' + error.message);
                if (photoInput) {
                    photoInput.disabled = false;
                    clearExistingEquipmentPhotoPreview();
                }
            });
        }

        function openModalForSite() {
            console.log('openModalForSite called');
            
            // Limpiar el formulario
            document.getElementById('siteForm').reset();
            
            // Abrir el modal usando Bootstrap
            const modalElement = document.getElementById('addSiteModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
                modalInstance.show();
            } else {
                console.error('Modal addSiteModal not found');
            }
        }

        function closeSiteModal() {
            console.log('closeSiteModal called');
            const modalElement = document.getElementById('addSiteModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            // Limpiar foto preview
            clearSitePhotoPreview();
            // Limpiar el formulario al cerrar
            document.getElementById('siteForm').reset();
        }

        function saveSite() {
            console.log('saveSite called');
            
            // Validar el formulario
            const form = document.getElementById('siteForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Validar campos con patrones específicos
            const description = document.getElementById('siteDescription').value.trim();
            if (description && !/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(description)) {
                alert('La descripción solo puede contener letras');
                return;
            }
            
            const siteLocation = document.getElementById('siteLocation').value.trim();
            if (!siteLocation) {
                alert('Por favor selecciona un sitio');
                return;
            }
            
            const brand = document.getElementById('siteBrand').value.trim();
            if (brand && !/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(brand)) {
                alert('La marca solo puede contener letras');
                return;
            }
            
            // Generar SKU único automáticamente
            const autoSKU = generateUniqueSKU();
            
            // Generar marbete único basado en el serial o SKU
            const serial = document.getElementById('siteSerial').value.trim();
            const label = serial || autoSKU;
            
            // Construir descripción completa con specs y sub_specs
            const specs = document.getElementById('siteSpecs').value.trim();
            const subSpecs = document.getElementById('siteSubSpecs').value.trim();
            let fullDescription = description;
            if (specs || subSpecs) {
                const specsText = [];
                if (specs) specsText.push(`Especificaciones/EXT: ${specs}`);
                if (subSpecs) specsText.push(`Sub-Especific: ${subSpecs}`);
                if (fullDescription) {
                    fullDescription = `${fullDescription}\n${specsText.join('\n')}`;
                } else {
                    fullDescription = specsText.join('\n');
                }
            }
            
            // Mapear estado del formulario al formato del backend
            const statusMap = {
                'operativo': 'active',
                'criterio_tecnico': 'maintenance',
                'descarte': 'inactive'
            };
            const formStatus = document.getElementById('siteStatus').value;
            const mappedStatus = statusMap[formStatus] || 'active';
            
            // Obtener photo_url si se subió una foto
            const photoInput = document.getElementById('sitePhoto');
            const photoUrl = photoInput && photoInput.dataset.uploadedPhotoUrl ? photoInput.dataset.uploadedPhotoUrl : null;
            
            // Mapear datos del formulario al formato que espera el backend
            const productData = {
                sku: autoSKU,
                name: brand && document.getElementById('siteModel').value.trim() 
                    ? `${brand} ${document.getElementById('siteModel').value.trim()}`.trim()
                    : brand || document.getElementById('siteModel').value.trim() || 'Sitio',
                description: fullDescription || '',
                brand: brand || '',
                model: document.getElementById('siteModel').value.trim() || '',
                serial_number: serial || autoSKU,
                department: siteLocation,
                label: label,
                barcode: document.getElementById('siteNumericAssign').value.trim() || `INV-${autoSKU}`,
                stock_quantity: parseInt(document.getElementById('siteQuantity').value, 10) || 1,
                price: 0,
                cost: 0,
                category_id: 1, // Por defecto
                supplier_id: 1, // Por defecto
                type: 'sitio', // Identificador para sitios
                status: mappedStatus,
                photo_url: photoUrl, // Incluir URL de la foto si existe
                lugar: document.getElementById('siteLugar').value.trim() || null
            };
            
            console.log('Datos del sitio a guardar:', productData);
            
            // Enviar datos al servidor
            fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Sitio guardado exitosamente:', data);
                    alert('Sitio guardado exitosamente');
                    closeSiteModal();
                    // Recargar productos para actualizar la lista
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                    }
                } else {
                    console.error('Error al guardar sitio:', data);
                    alert('Error al guardar sitio: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error al guardar sitio:', error);
                alert('Error al guardar sitio: ' + error.message);
            });
        }

        function captureSitePhoto() {
            // Verificar si el navegador soporta la API de cámara
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Intentar acceder a la cámara
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Cámara trasera en móviles
                    } 
                })
                .then(stream => {
                    // Mostrar modal de cámara
                    showCameraModalForSite(stream);
                })
                .catch(error => {
                    console.error('Error al acceder a la cámara:', error);
                    // Si falla, usar el input de archivo
                    const photoInput = document.getElementById('sitePhoto');
                    if (photoInput) {
                        photoInput.click();
                    }
                });
            } else {
                // Si no hay soporte, usar el input de archivo
                const photoInput = document.getElementById('sitePhoto');
                if (photoInput) {
                    photoInput.click();
                }
            }
        }

        function showCameraModalForSite(stream) {
            // Crear modal de cámara si no existe
            let cameraModal = document.getElementById('cameraModalForSite');
            if (!cameraModal) {
                cameraModal = document.createElement('div');
                cameraModal.id = 'cameraModalForSite';
                cameraModal.className = 'modal fade';
                cameraModal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Tomar Foto</h5>
                                <button type="button" class="btn-close" onclick="closeCameraModalForSite()"></button>
                            </div>
                            <div class="modal-body text-center">
                                <video id="siteCameraVideo" autoplay playsinline style="width: 100%; max-width: 500px;"></video>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeCameraModalForSite()">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="takePictureForSite()">Tomar Foto</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(cameraModal);
            }
            
            const video = document.getElementById('siteCameraVideo');
            if (video) {
                video.srcObject = stream;
                const modalInstance = bootstrap.Modal.getOrCreateInstance(cameraModal);
                modalInstance.show();
                
                // Guardar stream para cerrarlo después
                cameraModal.dataset.stream = stream;
            }
        }

        function takePictureForSite() {
            const video = document.getElementById('siteCameraVideo');
            if (!video) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                if (blob) {
                    processCameraPhotoForSite(blob);
                }
            }, 'image/jpeg', 0.9);
            
            closeCameraModalForSite();
        }

        function processCameraPhotoForSite(blob) {
            const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
            const photoInput = document.getElementById('sitePhoto');
            
            // Crear un DataTransfer para asignar el archivo al input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            if (photoInput) {
                photoInput.files = dataTransfer.files;
                
                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('sitePhotoPreview');
                    const previewImg = document.getElementById('sitePhotoPreviewImg');
                    if (preview && previewImg) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    // Subir foto automáticamente
                    uploadSitePhoto(file);
                };
                reader.readAsDataURL(file);
            }
        }

        function closeCameraModalForSite() {
            const cameraModal = document.getElementById('cameraModalForSite');
            if (cameraModal) {
                const stream = cameraModal.dataset.stream;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                const modalInstance = bootstrap.Modal.getInstance(cameraModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        }

        function clearSitePhotoPreview() {
            const photoInput = document.getElementById('sitePhoto');
            const photoPreview = document.getElementById('sitePhotoPreview');
            if (photoInput) {
                photoInput.value = '';
                photoInput.dataset.uploadedPhotoUrl = '';
            }
            if (photoPreview) {
                photoPreview.style.display = 'none';
                const previewImg = document.getElementById('sitePhotoPreviewImg');
                if (previewImg) {
                    previewImg.src = '';
                }
            }
        }

        function uploadSitePhoto(file) {
            const formData = new FormData();
            formData.append('photo', file);
            
            // Mostrar indicador de carga
            const photoInput = document.getElementById('sitePhoto');
            if (photoInput) {
                photoInput.disabled = true;
            }
            
            fetch('/api/upload-photo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && photoInput) {
                    photoInput.dataset.uploadedPhotoUrl = data.photo_url;
                    console.log('Foto subida exitosamente:', data.photo_url);
                } else {
                    console.error('Error al subir foto:', data);
                    alert('Error al subir la foto: ' + (data.message || 'Error desconocido'));
                    if (photoInput) {
                        photoInput.disabled = false;
                        clearSitePhotoPreview();
                    }
                }
            })
            .catch(error => {
                console.error('Error al subir foto:', error);
                alert('Error al subir la foto: ' + error.message);
                if (photoInput) {
                    photoInput.disabled = false;
                    clearSitePhotoPreview();
                }
            });
        }

        // Agregar event listener para el input de foto de sitio
        document.addEventListener('DOMContentLoaded', function() {
            const sitePhotoInput = document.getElementById('sitePhoto');
            if (sitePhotoInput) {
                sitePhotoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const preview = document.getElementById('sitePhotoPreview');
                            const previewImg = document.getElementById('sitePhotoPreviewImg');
                            if (preview && previewImg) {
                                previewImg.src = e.target.result;
                                preview.style.display = 'block';
                            }
                            uploadSitePhoto(file);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function updateProduct() {
            console.log('updateProduct called');
            
            if (!currentEditProductId) {
                alert('Error: No se ha seleccionado un producto para editar');
                return;
            }
            
            // Recopilar datos del formulario
            const getTrimmedValue = (id) => {
                const element = document.getElementById(id);
                return element && typeof element.value === 'string' ? element.value.trim() : '';
            };

            const productData = {
                id: currentEditProductId,
                name: getTrimmedValue('editProductName'),
                description: getTrimmedValue('editProductDescription'),
                brand: getTrimmedValue('editProductBrand'),
                model: getTrimmedValue('editProductModel'),
                price: parseFloat(getTrimmedValue('editProductPrice')) || 0,
                stock_quantity: parseInt(getTrimmedValue('editProductStock'), 10) || 0,
                category_id: getTrimmedValue('editProductCategory') || '1',
                supplier_id: getTrimmedValue('editProductSupplier') || '1',
                type: getTrimmedValue('editProductType') || 'computo',
                serial_number: getTrimmedValue('editProductSerial'),
                department: getTrimmedValue('editProductDepartment'),
                label: getTrimmedValue('editProductLabel'),
                barcode: getTrimmedValue('editProductBarcode'),
                status: getTrimmedValue('editProductStatus') || 'active'
            };
            
            // Obtener photo_url (de la foto subida o la actual)
            const photoInput = document.getElementById('editProductPhoto');
            if (photoInput && photoInput.dataset.uploadedPhotoUrl) {
                productData.photo_url = photoInput.dataset.uploadedPhotoUrl;
            } else if (photoInput && photoInput.dataset.currentPhotoUrl) {
                productData.photo_url = photoInput.dataset.currentPhotoUrl;
            }
            
            console.log('Frontend updateProduct: Datos a enviar:', productData);
            console.log('Frontend updateProduct: Tipo seleccionado:', productData.type);
            console.log('Frontend updateProduct: Departamento seleccionado:', productData.department);
            
            // Validar campos requeridos
            const requiredFields = ['name', 'serial_number', 'label'];
            for (const field of requiredFields) {
                if (!productData[field]) {
                    alert(`El campo ${field} es obligatorio`);
                    return;
                }
            }
            
            console.log('Enviando datos de actualización:', productData);
            
            // Enviar solicitud PUT
            fetch('/products', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito más visible
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto actualizado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    closeEditModal();
                    // Recargar los productos usando window.app
                    if (window.app && window.app.loadProducts) {
                        console.log('Recargando productos después de actualizar...');
                        window.app.loadProducts();
                        // También recargar el resumen del inventario
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    } else {
                        console.log('window.app no disponible - esperando a que se inicialice...');
                        // Esperar un momento y luego intentar recargar
                        setTimeout(() => {
                            if (window.app && window.app.loadProducts) {
                                window.app.loadProducts();
                                if (window.app.loadInventorySummary) {
                                    window.app.loadInventorySummary();
                                }
                            } else {
                                console.error('No se pudo recargar los productos - window.app no disponible');
                            }
                        }, 1000);
                    }
                } else {
                    // Mostrar mensaje de error más visible
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                    errorMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    errorMessage.innerHTML = `
                        <strong>Error:</strong> ${data.error || 'Error desconocido'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(errorMessage);
                    
                    // Auto-remover después de 8 segundos
                    setTimeout(() => {
                        if (errorMessage.parentNode) {
                            errorMessage.parentNode.removeChild(errorMessage);
                        }
                    }, 8000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el producto: ' + error.message);
            });
        }

        function deleteProduct(productId) {
            console.log('deleteProduct called with ID:', productId);
            
            if (!confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.')) {
                return;
            }
            
            fetch('/products', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: productId })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto eliminado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    // Recargar los productos
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    }
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto: ' + error.message);
            });
        }

        function viewProduct(productId) {
            console.log('viewProduct called with ID:', productId);
            // Por ahora solo mostrar alerta, se puede implementar un modal de vista después
            alert('Función de vista de producto en desarrollo. ID: ' + productId);
        }
    </script>

    <!-- Modal de Editar Producto -->
    <div class="modal fade" id="editProductModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close" onclick="closeEditModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="editProductSku" readonly>
                                    <div class="form-text">(No editable)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductName" class="form-label">Nombre del Producto</label>
                                    <input type="text" class="form-control" id="editProductName">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductBrand" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="editProductBrand">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductModel" class="form-label">Modelo</label>
                                    <input type="text" class="form-control" id="editProductModel">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSerial" class="form-label">Número de Serial</label>
                                    <input type="text" class="form-control" id="editProductSerial">
                                    <div class="form-text">(De debe ser único)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductLabel" class="form-label">Marbete</label>
                                    <input type="text" class="form-control" id="editProductLabel">
                                    <div class="form-text">(Debe ser único)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductCategory" class="form-label">Categoría</label>
                                    <select class="form-select" id="editProductCategory">
                                        <option value="1">Electrónica</option>
                                        <option value="2">Iluminación</option>
                                        <option value="3">Resistores</option>
                                        <option value="4">Capacitores</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSupplier" class="form-label">Proveedor</label>
                                    <select class="form-select" id="editProductSupplier">
                                        <option value="1">Mouser Electronics</option>
                                        <option value="2">Digi-Key</option>
                                        <option value="3">Arrow Electronics</option>
                                        <option value="4">Farnell</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductType" class="form-label">Tipo de Equipo</label>
                                    <select class="form-select" id="editProductType">
                                        <option value="">Seleccionar tipo</option>
                                        <option value="telecomunicacion">Equipo de telecomunicación</option>
                                        <option value="computo">Equipos de cómputo</option>
                                    </select>
                                    <div class="form-text">Selecciona el tipo de equipo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductDepartment" class="form-label">Departamento</label>
                                    <select class="form-select" id="editProductDepartment">
                                        <option value="">Sin asignar</option>
                                        <option value="Telemática">Telemática</option>
                                        <option value="S1">S1</option>
                                        <option value="Protección">Protección</option>
                                        <option value="S3">S3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductPrice" class="form-label">Precio</label>
                                    <input type="number" step="0.01" class="form-control" id="editProductPrice">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductStock" class="form-label">Cantidad en Stock</label>
                                    <input type="number" class="form-control" id="editProductStock">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductBarcode" class="form-label">Código de Barras</label>
                                    <input type="text" class="form-control" id="editProductBarcode">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductStatus" class="form-label">Estado</label>
                                    <select class="form-select" id="editProductStatus">
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="maintenance">Mantenimiento</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductPhoto" class="form-label">Foto del Equipo</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex gap-2">
                                    <input type="file" class="form-control" id="editProductPhoto" accept="image/*" capture="environment">
                                    <button type="button" class="btn btn-outline-secondary" onclick="capturePhoto()">
                                        <i class="fas fa-camera"></i> Tomar Foto
                                    </button>
                                </div>
                                <div id="editProductPhotoPreview" class="mt-2" style="display: none;">
                                    <img id="editProductPhotoPreviewImg" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearPhotoPreview()">
                                        <i class="fas fa-times"></i> Eliminar
                                    </button>
                                </div>
                                <div id="editProductPhotoCurrent" class="mt-2" style="display: none;">
                                    <p class="text-muted small">Foto actual:</p>
                                    <img id="editProductPhotoCurrentImg" src="" alt="Foto actual" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                </div>
                            </div>
                            <div class="form-text">Puedes tomar una foto con la cámara o seleccionar un archivo de imagen</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Equipo Existente -->
    <div class="modal fade" id="addExistingEquipmentModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-server me-2"></i>
                        Agregar Equipo Existente
                    </h5>
                    <button type="button" class="btn-close" onclick="closeExistingEquipmentModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="existingEquipmentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentLocationType" class="form-label">Tipo de Ubicación *</label>
                                    <select class="form-select" id="existingEquipmentLocationType" required onchange="updateDepartmentOptions()">
                                        <option value="">Seleccionar tipo</option>
                                        <option value="departamento">Departamento</option>
                                        <option value="sitio">Sitio</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentDepartment" class="form-label">Departamento/Sitio donde está ubicado *</label>
                                    <select class="form-select" id="existingEquipmentDepartment" required>
                                        <option value="">Primero selecciona el tipo de ubicación</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentQuantity" class="form-label">Cantidad *</label>
                                    <input type="number" class="form-control" id="existingEquipmentQuantity" required 
                                           min="1" step="1"
                                           placeholder="Ej: 5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentSpecs" class="form-label">Especificaciones/EXT</label>
                                    <input type="text" class="form-control" id="existingEquipmentSpecs" 
                                           pattern="[A-Za-z0-9\s]+"
                                           placeholder="Ej: EXT-123 o ABC456"
                                           title="Solo letras y números">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentSubSpecs" class="form-label">Sub-Especific</label>
                                    <input type="text" class="form-control" id="existingEquipmentSubSpecs" 
                                           pattern="[A-Za-z0-9\s]+"
                                           placeholder="Ej: SUB-001 o XYZ789"
                                           title="Solo letras y números">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentNumericAssign" class="form-label">Asig. Numérica</label>
                                    <input type="text" class="form-control" id="existingEquipmentNumericAssign" 
                                           placeholder="Ej: 12345">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentStatus" class="form-label">Estado *</label>
                                    <select class="form-select" id="existingEquipmentStatus" required>
                                        <option value="">Seleccionar estado</option>
                                        <option value="operativo">Operativo</option>
                                        <option value="criterio_tecnico">Criterio Técnico</option>
                                        <option value="descarte">Descarte</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="existingEquipmentDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="existingEquipmentDescription" rows="3" 
                                      placeholder="Descripción del equipo (solo letras)"
                                      title="Solo se permiten letras"></textarea>
                            <div class="form-text">Solo se permiten letras</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentBrand" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="existingEquipmentBrand" 
                                           pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                                           placeholder="Ej: Motorola"
                                           title="Solo se permiten letras">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="existingEquipmentModel" class="form-label">Modelo</label>
                                    <input type="text" class="form-control" id="existingEquipmentModel" 
                                           pattern="[A-Za-z0-9\s\-]+"
                                           placeholder="Ej: R7 o ABC-123"
                                           title="Letras y números permitidos">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="existingEquipmentSerial" class="form-label">Serie</label>
                            <input type="text" class="form-control" id="existingEquipmentSerial" 
                                   pattern="[A-Za-z0-9\s\-]+"
                                   placeholder="Ej: SER-12345 o ABC123"
                                   title="Letras y números permitidos">
                        </div>
                        
                        <div class="mb-3">
                            <label for="existingEquipmentPhoto" class="form-label">Foto del Equipo</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex gap-2">
                                    <input type="file" class="form-control" id="existingEquipmentPhoto" accept="image/*" capture="environment">
                                    <button type="button" class="btn btn-outline-secondary" onclick="captureExistingEquipmentPhoto()">
                                        <i class="fas fa-camera"></i> Tomar Foto
                                    </button>
                                </div>
                                <div id="existingEquipmentPhotoPreview" class="mt-2" style="display: none;">
                                    <img id="existingEquipmentPhotoPreviewImg" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearExistingEquipmentPhotoPreview()">
                                        <i class="fas fa-times"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">Puedes tomar una foto con la cámara o seleccionar un archivo de imagen</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeExistingEquipmentModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveExistingEquipment()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Sitio -->
    <div class="modal fade" id="addSiteModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Agregar Sitio
                    </h5>
                    <button type="button" class="btn-close" onclick="closeSiteModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="siteForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteLocation" class="form-label">Sitio donde está ubicado *</label>
                                    <select class="form-select" id="siteLocation" required>
                                        <option value="">Seleccionar sitio</option>
                                        <option value="Cerro Ancón">Cerro Ancón</option>
                                        <option value="Edificio Pradera">Edificio Pradera</option>
                                        <option value="Cerro Oscuro">Cerro Oscuro</option>
                                        <option value="Palacio">Palacio</option>
                                        <option value="Cerro Galera">Cerro Galera</option>
                                        <option value="Cerro Santa Rita">Cerro Santa Rita</option>
                                        <option value="Cerro Jefe">Cerro Jefe</option>
                                        <option value="Cerro Buenos Aires Chepo">Cerro Buenos Aires Chepo</option>
                                        <option value="Aguas Frías">Aguas Frías</option>
                                        <option value="Cerro Mena">Cerro Mena</option>
                                        <option value="Cerro La Silla">Cerro La Silla</option>
                                        <option value="Cerro Taboga">Cerro Taboga</option>
                                        <option value="Cerro Canajagua">Cerro Canajagua</option>
                                        <option value="Cerro Peña">Cerro Peña</option>
                                        <option value="Cerro Boca Viento">Cerro Boca Viento</option>
                                        <option value="Cerro Zancudo">Cerro Zancudo</option>
                                        <option value="Meseta de Chorcha">Meseta de Chorcha</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteQuantity" class="form-label">Cantidad *</label>
                                    <input type="number" class="form-control" id="siteQuantity" required 
                                           min="1" step="1"
                                           placeholder="Ej: 5">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="siteLugar" class="form-label">Lugar</label>
                                    <input type="text" class="form-control" id="siteLugar" 
                                           placeholder="Ej: CAMPANA - CERRO MENA">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteSpecs" class="form-label">Especificaciones/EXT</label>
                                    <input type="text" class="form-control" id="siteSpecs" 
                                           pattern="[A-Za-z0-9\s]+"
                                           placeholder="Ej: EXT-123 o ABC456"
                                           title="Solo letras y números">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteSubSpecs" class="form-label">Sub-Especific</label>
                                    <input type="text" class="form-control" id="siteSubSpecs" 
                                           pattern="[A-Za-z0-9\s]+"
                                           placeholder="Ej: SUB-001 o XYZ789"
                                           title="Solo letras y números">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteNumericAssign" class="form-label">Asig. Numérica</label>
                                    <input type="text" class="form-control" id="siteNumericAssign" 
                                           placeholder="Ej: 12345">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteStatus" class="form-label">Estado *</label>
                                    <select class="form-select" id="siteStatus" required>
                                        <option value="">Seleccionar estado</option>
                                        <option value="operativo">Operativo</option>
                                        <option value="criterio_tecnico">Criterio Técnico</option>
                                        <option value="descarte">Descarte</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="siteDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="siteDescription" rows="3" 
                                      placeholder="Descripción del equipo (solo letras)"
                                      title="Solo se permiten letras"></textarea>
                            <div class="form-text">Solo se permiten letras</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteBrand" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="siteBrand" 
                                           pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                                           placeholder="Ej: Motorola"
                                           title="Solo se permiten letras">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siteModel" class="form-label">Modelo</label>
                                    <input type="text" class="form-control" id="siteModel" 
                                           pattern="[A-Za-z0-9\s\-]+"
                                           placeholder="Ej: R7 o ABC-123"
                                           title="Letras y números permitidos">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="siteSerial" class="form-label">Serie</label>
                            <input type="text" class="form-control" id="siteSerial" 
                                   pattern="[A-Za-z0-9\s\-]+"
                                   placeholder="Ej: SER-12345 o ABC123"
                                   title="Letras y números permitidos">
                        </div>
                        
                        <div class="mb-3">
                            <label for="sitePhoto" class="form-label">Foto del Equipo</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="d-flex gap-2">
                                    <input type="file" class="form-control" id="sitePhoto" accept="image/*" capture="environment">
                                    <button type="button" class="btn btn-outline-secondary" onclick="captureSitePhoto()">
                                        <i class="fas fa-camera"></i> Tomar Foto
                                    </button>
                                </div>
                                <div id="sitePhotoPreview" class="mt-2" style="display: none;">
                                    <img id="sitePhotoPreviewImg" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearSitePhotoPreview()">
                                        <i class="fas fa-times"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">Puedes tomar una foto con la cámara o seleccionar un archivo de imagen</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSiteModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveSite()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Producto -->
    <div class="modal fade" id="addProductModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Agregar Nuevo Producto
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <!-- Información Básica -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información Básica
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="productSku" required 
                                           placeholder="Se genera automáticamente" maxlength="20" readonly>
                                    <div class="form-text">Código único del producto (generado automáticamente)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="productName" required 
                                           placeholder="Ej: Resistor 1K Ohm 1/4W">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Marca *</label>
                                    <input type="text" class="form-control" id="productBrand" required 
                                           placeholder="Ej: Vishay">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Modelo *</label>
                                    <input type="text" class="form-control" id="productModel" required 
                                           placeholder="Ej: CRCW0805">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" id="productDescription" rows="3" 
                                              placeholder="Descripción detallada del producto"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Categoría *</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="1">Electrónica</option>
                                        <option value="2">Iluminación</option>
                                        <option value="3">Resistores</option>
                                        <option value="4">Capacitores</option>
                                        <option value="5">Cables</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Proveedor *</label>
                                    <select class="form-select" id="productSupplier" required>
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="1">Mouser Electronics</option>
                                        <option value="2">Digi-Key Electronics</option>
                                        <option value="3">Farnell</option>
                                        <option value="4">RS Components</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Equipo *</label>
                                    <select class="form-select" id="productType" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="telecomunicacion">Equipo de telecomunicación</option>
                                        <option value="computo">Equipos de cómputo</option>
                                    </select>
                                    <div class="form-text">Selecciona el tipo de equipo que estás agregando</div>
                                </div>
                            </div>
                            
                            <!-- Información de Inventario -->
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Información de Inventario
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Número de Serial *</label>
                                    <input type="text" class="form-control" id="productSerial" required 
                                           placeholder="Ej: RES001-2025-001" maxlength="30">
                                    <div class="form-text">Número único de serie del producto (OBLIGATORIO)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Departamento *</label>
                                    <select class="form-select" id="productDepartment" required>
                                        <option value="">Seleccionar departamento</option>
                                        <option value="Telemática">Telemática</option>
                                        <option value="S1">S1</option>
                                        <option value="Protección">Protección</option>
                                        <option value="S3">S3</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Marbete/Etiqueta *</label>
                                    <input type="text" class="form-control" id="productLabel" required 
                                           placeholder="Ej: RES-1K-001" maxlength="20">
                                    <div class="form-text">Etiqueta física del producto (OBLIGATORIO)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Código de Barras</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="productBarcode" 
                                               placeholder="Se genera automáticamente">
                                        <button class="btn btn-outline-secondary" type="button" onclick="generateBarcode()">
                                            <i class="fas fa-barcode"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Código de barras para escaneo</div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Información Financiera -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    Información Financiera
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Precio de Costo *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="productCost" required 
                                               step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Precio de Venta *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="productPrice" required 
                                               step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-info mb-3">
                                    <i class="fas fa-boxes me-2"></i>
                                    Control de Stock
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Cantidad en Stock *</label>
                                    <input type="number" class="form-control" id="productStock" required 
                                           min="0" placeholder="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Mínimo *</label>
                                    <input type="number" class="form-control" id="productMinStock" required 
                                           min="0" placeholder="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Máximo</label>
                                    <input type="number" class="form-control" id="productMaxStock" 
                                           min="0" placeholder="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información Adicional -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Expiración</label>
                                    <input type="date" class="form-control" id="productExpiration">
                                    <div class="form-text">Opcional - Para productos perecederos</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="productStatus">
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="discontinued">Descontinuado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-1"></i>
                        Guardar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>

