<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js" rel="preload">
    <style>
        .modal.show {
            display: block !important;
        }
        
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
        
        #addProductModal {
            z-index: 1055;
        }
        
        #addProductModal.show {
            display: block !important;
        }
        
        #editProductModal {
            z-index: 1055;
        }
        
        #editProductModal.show {
            display: block !important;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
        }
        
        /* Estilos para dropdown items */
        .sidebar .dropdown-menu {
            background-color: #1a1a1a;
            border: 1px solid #FFD700;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar .dropdown-item {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
            padding: 8px 16px;
        }
        
        .sidebar .dropdown-item:hover {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
        }
        
        .sidebar .dropdown-item.active {
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.3);
            font-weight: bold;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: box-shadow 0.15s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .stat-card {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: #000;
        }
        .stat-card .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Colores pastel y hover para filas de tabla */
        .table tbody tr {
            background-color: #fff;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .table tbody tr:nth-child(even) {
            background-color: #f5f7fa;
        }
        
        .table tbody tr:nth-child(even):hover {
            background-color: #e8ebef;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            border: none;
            color: #000;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #B8860B 0%, #8B6914 100%);
            color: #fff;
        }
        .search-box {
            position: relative;
        }
        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        .badge-status {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .navbar-brand {
            color: #FFD700 !important;
        }
        .btn-outline-light:hover {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #000;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
        }
        .badge.bg-success {
            background-color: #28a745 !important;
        }
        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        .badge.bg-danger {
            background-color: #dc3545 !important;
        }
        .btn-outline-primary {
            color: #FFD700;
            border-color: #FFD700;
        }
        .btn-outline-primary:hover {
            background-color: #FFD700;
            border-color: #FFD700;
            color: #000;
        }
        .btn-outline-info {
            color: #6c757d;
            border-color: #6c757d;
        }
        .btn-outline-info:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }
        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-danger:hover {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                    <div class="position-sticky pt-3">
                        <div class="text-center mb-4">
                            <h4 class="text-white">
                                <i class="fas fa-warehouse me-2"></i>
                                Inventario
                            </h4>
                        </div>
                        
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'dashboard'}" @click="setView('dashboard')">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'inventory'}" @click="setView('inventory')">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Inventario
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" @click="setView('products'); setProductFilter('all')">
                                    <i class="fas fa-boxes me-2"></i>
                                    Productos
                                </a>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" :class="{active: currentView === 'products' && productFilter === 'telecomunicacion'}" @click="setView('products'); setProductFilter('telecomunicacion')">
                                            <i class="fas fa-broadcast-tower me-2"></i>
                                            Equipo de telecomunicación
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" :class="{active: currentView === 'products' && productFilter === 'computo'}" @click="setView('products'); setProductFilter('computo')">
                                            <i class="fas fa-desktop me-2"></i>
                                            Equipos de cómputo
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'categories'}" @click="setView('categories')">
                                    <i class="fas fa-tags me-2"></i>
                                    Categorías
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'suppliers'}" @click="setView('suppliers')">
                                    <i class="fas fa-truck me-2"></i>
                                    Proveedores
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'reports'}" @click="setView('reports')">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Reportes
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" :class="{active: currentView === 'sports-calendar'}" @click="setView('sports-calendar')">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Calendario Deportivo
                                </a>
                            </li>
                            <!-- Navegación a páginas PHP reales en Render (visibles según rol) -->
                            <li class="nav-item" v-if="['admin','manager'].includes(user.role)">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('config.php')">
                                    <i class="fas fa-cog me-2"></i>
                                    Configuración
                                </a>
                            </li>
                            <li class="nav-item" v-if="user.role==='admin'">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('users.php')">
                                    <i class="fas fa-users me-2"></i>
                                    Usuarios
                                </a>
                            </li>
                            <li class="nav-item" v-if="['admin','manager'].includes(user.role)">
                                <a class="nav-link" href="#" @click.prevent="navigateToPHP('maintenance.php')">
                                    <i class="fas fa-tools me-2"></i>
                                    Mantenimiento
                                </a>
                            </li>
                        </ul>
                        
                        <hr class="text-white">
                        
                        <div class="text-center">
                            <small class="text-white-50">
                                <span v-if="user && user.role !== 'guest'">
                                Usuario: {{ user.name }} ({{ user.role }})<br>
                                <a href="/logout.php" class="btn btn-sm btn-outline-light mt-2">
                                    <i class="fas fa-sign-out-alt me-1"></i>
                                    Cerrar Sesión
                                </a>
                                </span>
                                <span v-else>
                                    No Autenticado<br>
                                    <a href="/login.php" class="btn btn-sm btn-outline-light mt-2" @click.prevent="goToLogin">
                                        <i class="fas fa-sign-in-alt me-1"></i>
                                        Iniciar Sesión
                                    </a>
                                </span>
                            </small>
                        </div>
                    </div>
                </nav>

                <!-- Main content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">{{ getPageTitle() }}</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" @click="refreshData">
                                    <i class="fas fa-sync-alt"></i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard View -->
                    <div v-if="currentView === 'dashboard'">
                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Total Productos
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ inventorySummary.total_products || 0 }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-boxes stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Valor Total
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">${{ formatNumber(inventorySummary.total_value || 0) }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-dollar-sign stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Stock Bajo
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ inventorySummary.low_stock_products ? inventorySummary.low_stock_products.length : 0 }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-xl-3 col-md-6 mb-4">
                                <div class="card stat-card">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-uppercase mb-1">
                                                    Proveedores
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold">{{ suppliers.length }}</div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-truck stat-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Products -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-boxes me-2"></i>
                                            Productos Recientes
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div v-if="loading" class="text-center py-5">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="mt-2">Cargando...</p>
                                        </div>
                                        <div v-else-if="recentProducts.length === 0" class="text-center py-5 text-muted">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>No hay productos recientes.</p>
                                        </div>
                                        <div v-else class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>SKU</th>
                                                        <th>Nombre</th>
                                                        <th>Stock</th>
                                                        <th>Precio</th>
                                                        <th>Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="product in recentProducts" :key="product.id">
                                                        <td>
                                                            <code>{{ product.sku }}</code>
                                                        </td>
                                                        <td>{{ product.name }}</td>
                                                        <td>
                                                            <span class="badge" :class="getStockBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                                {{ product.stock_quantity }}
                                                            </span>
                                                        </td>
                                                        <td>${{ formatNumber(product.price) }}</td>
                                                        <td>
                                                            <span class="badge badge-status" :class="getStatusBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                                {{ getStatusText(product.stock_quantity, product.min_stock_level) }}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Stock Bajo
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div v-if="lowStockProducts.length === 0" class="text-center text-muted">
                                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                                            <p>¡Excelente! No hay productos con stock bajo.</p>
                                        </div>
                                        <div v-else>
                                            <div v-for="product in lowStockProducts" :key="product.id" class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <strong>{{ product.name }}</strong><br>
                                                    <small class="text-muted">{{ product.sku }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-danger">{{ product.stock_quantity }}</span><br>
                                                    <small class="text-muted">Mín: {{ product.min_stock_level }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory View -->
                    <div v-if="currentView === 'inventory'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Gestión de Inventario
                                </h5>
                                <div class="d-flex gap-2 mt-2 mt-md-0">
                                    <button class="btn btn-outline-secondary" @click="refreshInventory">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        Actualizar
                                    </button>
                                    <button class="btn btn-outline-primary" @click="searchInventory">
                                        <i class="fas fa-search me-1"></i>
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filtros de búsqueda -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por Categoría:</label>
                                        <select class="form-select" v-model="inventoryFilters.category" @change="filterInventory">
                                            <option value="">Todas las categorías</option>
                                            <option v-for="category in categories" :key="category.id" :value="category.name">{{ category.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar por Ubicación:</label>
                                        <select class="form-select" v-model="inventoryFilters.location" @change="filterInventory">
                                            <option value="">Todas las ubicaciones</option>
                                            <option v-for="location in locations" :key="location.id" :value="location.name">{{ location.name }}</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Buscar Producto:</label>
                                        <input type="text" class="form-control" v-model="inventoryFilters.search" @input="filterInventory" placeholder="SKU, nombre, serial...">
                                    </div>
                                </div>

                                <!-- Resumen del Inventario -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.total_products || 0 }}</h3>
                                                <p class="mb-0">Total Productos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h3>${{ (inventorySummary.total_value || 0).toFixed(2) }}</h3>
                                                <p class="mb-0">Valor Total</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.low_stock_products?.length || 0 }}</h3>
                                                <p class="mb-0">Stock Bajo</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center">
                                                <h3>{{ inventorySummary.unique_departments_count || 0 }}</h3>
                                                <p class="mb-0">Departamentos</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Inventario -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serial</th>
                                                <th>Marbete</th>
                                                <th>Tipo</th>
                                                <th>Categoría</th>
                                                <th>Proveedor</th>
                                                <th>Departamento</th>
                                                <th>Stock</th>
                                                <th>Precio</th>
                                                <th>Valor Total</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredInventory" :key="product.id">
                                                <td><code>{{ product.sku }}</code></td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td><small>{{ product.description || 'Sin descripción' }}</small></td>
                                                <td><strong>{{ product.brand || 'Sin marca' }}</strong></td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number }}</small></td>
                                                <td><code>{{ product.label }}</code></td>
                                                <td><span class="badge" :class="product.type === 'telecomunicacion' ? 'bg-primary' : 'bg-success'">{{ product.type === 'telecomunicacion' ? 'Telecomunicación' : 'Cómputo' }}</span></td>
                                                <td><span class="badge bg-secondary">{{ product.category_name }}</span></td>
                                                <td><span class="badge bg-info">{{ product.supplier_name }}</span></td>
                                                <td><span class="badge bg-warning">{{ product.department || 'Sin asignar' }}</span></td>
                                                <td>
                                                    <span class="badge" :class="product.stock_quantity <= product.min_stock_level ? 'bg-danger' : 'bg-success'">
                                                        {{ product.stock_quantity }}
                                                    </span>
                                                </td>
                                                <td>${{ (parseFloat(product.price) || 0).toFixed(2) }}</td>
                                                <td>${{ (parseFloat(product.stock_quantity) * parseFloat(product.price) || 0).toFixed(2) }}</td>
                                                <td>
                                                    <span class="badge" :class="product.status === 'active' ? 'bg-success' : 'bg-secondary'">
                                                        {{ product.status === 'active' ? 'Activo' : 'Inactivo' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                         <button class="btn btn-outline-primary" @click="editProduct(product)" title="Editar producto">
                                                              <i class="fas fa-edit"></i>
                                                          </button>
                                                         <button class="btn btn-outline-danger" @click="deleteProduct(product.id)" title="Eliminar producto">
                                                              <i class="fas fa-trash"></i>
                                                          </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products View -->
                    <div v-if="currentView === 'products'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-boxes me-2"></i>
                                    Gestión de Productos
                                </h5>
                                <button class="btn btn-primary mt-2 mt-md-0" onclick="openModal()">
                                    <i class="fas fa-plus me-1"></i>
                                    Agregar Producto
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filters -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="search-box">
                                            <input type="text" class="form-control" placeholder="Buscar productos..." v-model="searchQuery" @input="searchProducts">
                                            <i class="fas fa-search search-icon"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" v-model="selectedCategory" @change="filterProducts">
                                            <option value="">Todas las categorías</option>
                                            <option v-for="category in categories" :key="category.id" :value="category.id">
                                                {{ category.name }}
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" v-model="selectedSupplier" @change="filterProducts">
                                            <option value="">Todos los proveedores</option>
                                            <option v-for="supplier in suppliers" :key="supplier.id" :value="supplier.id">
                                                {{ supplier.name }}
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Products Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>SKU</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Marca</th>
                                                <th>Modelo</th>
                                                <th>Serial</th>
                                                <th>Marbete</th>
                                                <th>Tipo</th>
                                                <th>Categoría</th>
                                                <th>Proveedor</th>
                                                <th>Departamento</th>
                                                <th>Stock</th>
                                                <th>Precio</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="product in filteredProducts" :key="product.id">
                                                <td>
                                                    <code>{{ product.sku }}</code>
                                                </td>
                                                <td><strong>{{ product.name || 'Sin nombre' }}</strong></td>
                                                <td><small>{{ product.description || 'Sin descripción' }}</small></td>
                                                <td><strong>{{ product.brand || 'Sin marca' }}</strong></td>
                                                <td>{{ product.model || 'Sin modelo' }}</td>
                                                <td><small>{{ product.serial_number }}</small></td>
                                                <td><code>{{ product.label }}</code></td>
                                                <td><span class="badge" :class="product.type === 'telecomunicacion' ? 'bg-primary' : 'bg-success'">{{ product.type === 'telecomunicacion' ? 'Telecomunicación' : 'Cómputo' }}</span></td>
                                                <td><span class="badge bg-secondary">{{ product.category_name || 'Sin categoría' }}</span></td>
                                                <td><span class="badge bg-info">{{ product.supplier_name || 'Sin proveedor' }}</span></td>
                                                <td>
                                                    <span class="badge bg-warning text-dark">
                                                        {{ product.department || 'Sin asignar' }}
                                                    </span>
                                                </td>
                                                <td>${{ formatNumber(product.price) }}</td>
                                                <td>
                                                    <span class="badge badge-status" :class="getStatusBadgeClass(product.stock_quantity, product.min_stock_level)">
                                                        {{ getStatusText(product.stock_quantity, product.min_stock_level) }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" @click="editProduct(product.id)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-info" @click="viewProduct(product.id)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger" @click="deleteProduct(product.id)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categories View -->
                    <div v-if="currentView === 'categories'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-tags me-2"></i>
                                        Gestión de Categorías
                                    </h5>
                                </div>
                                <button class="btn btn-primary mt-2 mt-md-0">
                                    <i class="fas fa-plus me-1"></i>
                                    Nueva Categoría
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Descripción</th>
                                                <th>Productos</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="category in categories" :key="category.id">
                                                <td>{{ category.id }}</td>
                                                <td>{{ category.name }}</td>
                                                <td>{{ category.description }}</td>
                                                <td>
                                                    <span class="badge bg-success">{{ category.product_count }}</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Suppliers View -->
                    <div v-if="currentView === 'suppliers'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-truck me-2"></i>
                                        Gestión de Proveedores
                                    </h5>
                                </div>
                                <button class="btn btn-primary mt-2 mt-md-0">
                                    <i class="fas fa-plus me-1"></i>
                                    Nuevo Proveedor
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Contacto</th>
                                                <th>Email</th>
                                                <th>Teléfono</th>
                                                <th>Productos</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="supplier in suppliers" :key="supplier.id">
                                                <td>{{ supplier.id }}</td>
                                                <td>{{ supplier.name }}</td>
                                                <td>{{ supplier.contact_person }}</td>
                                                <td>{{ supplier.email }}</td>
                                                <td>{{ supplier.phone }}</td>
                                                <td>
                                                    <span class="badge bg-success">{{ supplier.product_count }}</span>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports View -->
                    <div v-if="currentView === 'reports'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Reportes del Sistema
                                    </h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-chart-pie fa-3x mb-3" style="color: #FFD700;"></i>
                                                <h5>Reporte de Inventario</h5>
                                                <p class="text-muted">Resumen completo del inventario</p>
                                                <button class="btn btn-primary">Generar Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-exclamation-triangle fa-3x mb-3" style="color: #ffc107;"></i>
                                                <h5>Stock Bajo</h5>
                                                <p class="text-muted">Productos con stock bajo</p>
                                                <button class="btn btn-primary">Ver Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-dollar-sign fa-3x mb-3" style="color: #28a745;"></i>
                                                <h5>Valor del Inventario</h5>
                                                <p class="text-muted">Valor total del inventario</p>
                                                <button class="btn btn-primary">Ver Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-truck fa-3x mb-3" style="color: #6c757d;"></i>
                                                <h5>Reporte de Proveedores</h5>
                                                <p class="text-muted">Análisis de proveedores</p>
                                                <button class="btn btn-primary">Generar Reporte</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sports Calendar View -->
                    <div v-if="currentView === 'sports-calendar'">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary me-3" @click="setView('dashboard')">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Volver al Dashboard
                                    </button>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        Calendario Deportivo
                                    </h5>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <!-- Card with blue line and tabs design -->
                                <div class="card" style="border-radius: 0 0 10px 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <!-- Blue line at top -->
                                    <div style="height: 4px; background: linear-gradient(90deg, #007bff, #0056b3); border-radius: 10px 10px 0 0;"></div>
                                    
                                    <!-- Tabs inside card -->
                                    <div class="card-body p-0">
                                        <ul class="nav nav-tabs border-0 px-3 pt-3" role="tablist" style="border-bottom: 1px solid #dee2e6 !important;">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link border-0" 
                                                        :class="{'active text-primary border-bottom border-primary border-2': sportsTab === 'calendar', 'text-secondary': sportsTab !== 'calendar'}"
                                                        @click="sportsTab = 'calendar'"
                                                        style="background: transparent;">
                                                    Calendario
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link border-0" 
                                                        :class="{'active text-primary border-bottom border-primary border-2': sportsTab === 'classification', 'text-secondary': sportsTab !== 'classification'}"
                                                        @click="sportsTab = 'classification'"
                                                        style="background: transparent;">
                                                    Clasificación
                                                </button>
                                            </li>
                                        </ul>
                                        
                                        <!-- Content area -->
                                        <div class="p-4">
                                            <!-- Calendar Tab -->
                                            <div v-if="sportsTab === 'calendar'" class="tab-content">
                                    <!-- Date Selection -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center gap-3">
                                                <label class="form-label mb-0">Fecha:</label>
                                                <input type="date" class="form-control" v-model="selectedDate" style="width: auto;">
                                                <button class="btn btn-primary" @click="updateTable">
                                                    <i class="fas fa-sync me-1"></i>
                                                    ACTUALIZAR TABLA
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Matchday Buttons -->
                                    <div class="mb-4">
                                        <div class="btn-group" role="group">
                                            <button 
                                                v-for="(matchday, index) in matchdays" 
                                                :key="index"
                                                class="btn btn-outline-primary" 
                                                :class="{active: currentMatchday === index + 1}"
                                                @click="currentMatchday = index + 1; loadMatchesForMatchday(index + 1)">
                                                Fecha {{ index + 1 }}
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Matches Table -->
                                    <div v-if="currentMatches.length > 0">
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Equipo Local</th>
                                                        <th>Resultado</th>
                                                        <th>Equipo Visitante</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="match in currentMatches" :key="match.id">
                                                        <td class="text-center">
                                                            <div class="d-flex align-items-center justify-content-center">
                                                                <span class="me-2">{{ match.homeTeam }}</span>
                                                                <i class="fas fa-circle" style="color: #007bff;"></i>
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="d-flex align-items-center justify-content-center gap-2">
                                                                <input 
                                                                    type="number" 
                                                                    class="form-control text-center" 
                                                                    style="width: 60px;"
                                                                    v-model="match.homeScore"
                                                                    @change="updateMatchResult(match)"
                                                                    min="0">
                                                                <span>VS</span>
                                                                <input 
                                                                    type="number" 
                                                                    class="form-control text-center" 
                                                                    style="width: 60px;"
                                                                    v-model="match.awayScore"
                                                                    @change="updateMatchResult(match)"
                                                                    min="0">
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="d-flex align-items-center justify-content-center">
                                                                <i class="fas fa-circle me-2" style="color: #dc3545;"></i>
                                                                <span>{{ match.awayTeam }}</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div v-else class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No hay partidos programados para esta fecha.
                                    </div>
                                            </div>

                                            <!-- Classification Tab -->
                                            <div v-if="sportsTab === 'classification'" class="tab-content">
                                                <div v-if="matchdays && matchdays.length > 0">
                                                    <!-- Elimination Directa Table -->
                                                    <h5 class="mb-3"><strong>Eliminación Directa</strong></h5>
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-hover">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Pos</th>
                                                                    <th>Equipo</th>
                                                                    <th>PJ</th>
                                                                    <th>PG</th>
                                                                    <th>PE</th>
                                                                    <th>PP</th>
                                                                    <th>GF</th>
                                                                    <th>GC</th>
                                                                    <th>DG</th>
                                                                    <th>Pts</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr v-for="(team, index) in eliminationTable" :key="team.name">
                                                                    <td><strong>{{ index + 1 }}</strong></td>
                                                                    <td>{{ team.name }}</td>
                                                                    <td>{{ team.played || 0 }}</td>
                                                                    <td>{{ team.wins || 0 }}</td>
                                                                    <td>{{ team.draws || 0 }}</td>
                                                                    <td>{{ team.losses || 0 }}</td>
                                                                    <td>{{ team.goalsFor || 0 }}</td>
                                                                    <td>{{ team.goalsAgainst || 0 }}</td>
                                                                    <td :class="{'text-success': (team.goalDiff || 0) > 0, 'text-danger': (team.goalDiff || 0) < 0}">
                                                                        {{ (team.goalDiff || 0) > 0 ? '+' : '' }}{{ team.goalDiff || 0 }}
                                                                    </td>
                                                                    <td><strong>{{ team.points || 0 }}</strong></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <div v-else>
                                                    <h5 class="mb-2"><strong>Eliminación Directa</strong></h5>
                                                    <p class="text-muted mb-0">El formato se mostrará cuando se genere el calendario</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div v-if="loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="text-center text-white">
                            <div class="loading-spinner mb-3"></div>
                            <p>Cargando...</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentView: 'dashboard',
                    loading: false,
                    user: { name: 'Cargando...', email: '', role: 'guest' },
                    products: [],
                    filteredProducts: [],
                    productFilter: 'all', // 'all', 'telecomunicacion', 'computo'
                    recentProducts: [],
                    lowStockProducts: [],
                    categories: [],
                    suppliers: [],
                    departments: [],
                    locations: [],
                    inventorySummary: {},
                    filteredInventory: [],
                    inventoryFilters: {
                        category: '',
                        location: '',
                        search: ''
                    },
                    searchQuery: '',
                    selectedCategory: '',
                    selectedSupplier: '',
                    showEditProductModal: false,
                    editingProduct: null,
                    _mounted: false, // Flag para prevenir múltiples mountings
                    // Sports Calendar
                    sportsTab: 'calendar',
                    matchdays: [],
                    currentMatchday: 1,
                    currentMatches: [],
                    selectedDate: new Date().toISOString().split('T')[0],
                    teams: ['Chelsea', 'Arsenal', 'Manchester City', 'Manchester United', 'Newcastle', 'Everton', 'Crystal Palace', 'Aston Villa'],
                    eliminationTable: []
                }
            },
            async mounted() {
                if (this._mounted) {
                    console.log('Mounted ya fue llamado, omitiendo...');
                    return;
                }
                this._mounted = true;
                console.log('Mounted ejecutándose por primera vez...');
                
                // Verificar si hay cookies de sesión antes de intentar cargar el usuario
                console.log('🍪 Verificando cookies de sesión:', document.cookie);
                
                await this.loadSessionUser();
                this.loadProducts();
                this.loadCategories();
                this.loadSuppliers();
                this.loadDepartments();
                this.loadLocations();
                this.loadInventorySummary();
            },
            methods: {
                async loadSessionUser() {
                    try {
                        console.log('🔍 Iniciando carga de sesión de usuario...');
                        const res = await fetch('/auth/me');
                        console.log('📡 Respuesta del servidor:', res.status, res.statusText);
                        
                        if (res.ok) {
                            const data = await res.json();
                            console.log('📦 Datos recibidos:', data);
                            
                            if (data.success && data.authenticated) {
                                this.user = data.data;
                                console.log('✅ Usuario autenticado cargado:', this.user);
                            } else {
                                console.error('❌ NO HAY SESIÓN ACTIVA - Datos recibidos:', data);
                                this.user = { name: 'No autenticado', email: '', role: 'guest' };
                                // NO redirigir automáticamente, solo mostrar el estado
                                console.log('⚠️ Sin sesión activa, usuario en modo invitado');
                            }
                        } else {
                            console.error('❌ ERROR EN RESPUESTA DEL SERVIDOR:', res.status);
                            this.user = { name: 'Error de conexión', email: '', role: 'guest' };
                            console.log('⚠️ Error del servidor, usuario en modo invitado');
                        }
                    } catch (error) {
                        console.error('❌ Error al cargar usuario:', error);
                        this.user = { name: 'Error de conexión', email: '', role: 'guest' };
                        console.log('⚠️ Error de conexión, usuario en modo invitado');
                    }
                    
                    console.log('👤 Usuario final asignado:', this.user);
                    
                    // Actualizar el DOM para mostrar el usuario real
                    if (this.user && this.user.role !== 'guest') {
                        console.log('✅ Usuario real detectado, rol:', this.user.role);
                    } else {
                        console.log('⚠️ Usuario no autenticado (guest)');
                    }
                },
                setView(view) {
                    this.currentView = view;
                    if (view === 'products') {
                        this.loadProducts();
                    }
                },
                setProductFilter(filter) {
                    console.log('setProductFilter called with:', filter);
                    this.productFilter = filter;
                    console.log('productFilter set to:', this.productFilter);
                    this.filterProducts();
                },
                
                getPageTitle() {
                    const titles = {
                        'dashboard': 'Dashboard',
                        'products': 'Productos',
                        'categories': 'Categorías',
                        'suppliers': 'Proveedores',
                        'reports': 'Reportes',
                        'settings': 'Configuración'
                    };
                    return titles[this.currentView] || 'Sistema de Inventario';
                },


                async loadProducts() {
                    this.loading = true;
                    try {
                        const response = await fetch('/products');
                        const data = await response.json();
                        if (data.success) {
                            this.products = data.data;
                            this.filterProducts(); // Aplicar filtro actual
                            this.recentProducts = data.data.slice(0, 10);
                            // También actualizar filteredInventory
                            this.filteredInventory = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading products:', error);
                    }
                    this.loading = false;
                },

                async loadCategories() {
                    try {
                        const response = await fetch('/categories');
                        const data = await response.json();
                        if (data.success) {
                            this.categories = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading categories:', error);
                    }
                },

                async loadSuppliers() {
                    try {
                        const response = await fetch('/suppliers');
                        const data = await response.json();
                        if (data.success) {
                            this.suppliers = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading suppliers:', error);
                    }
                },

                async loadDepartments() {
                    try {
                        const response = await fetch('/departments');
                        const data = await response.json();
                        if (data.success) {
                            this.departments = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading departments:', error);
                    }
                },

                async loadLocations() {
                    try {
                        const response = await fetch('/locations');
                        const data = await response.json();
                        if (data.success) {
                            this.locations = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading locations:', error);
                    }
                },

                async loadInventorySummary() {
                    try {
                        const response = await fetch('/inventory/summary');
                        const data = await response.json();
                        if (data.success) {
                            this.inventorySummary = data.data;
                            // Inicializar filteredInventory con todos los productos
                            this.filteredInventory = this.products.length > 0 ? this.products : [];
                        }
                    } catch (error) {
                        console.error('Error loading inventory summary:', error);
                        // Si hay error, usar los productos locales
                        this.filteredInventory = this.products;
                    }
                },

                filterInventory() {
                    let filtered = [...this.products];
                    
                    if (this.inventoryFilters.category) {
                        filtered = filtered.filter(product => 
                            product.category_name === this.inventoryFilters.category
                        );
                    }
                    
                    if (this.inventoryFilters.location) {
                        filtered = filtered.filter(product => 
                            product.location.includes(this.inventoryFilters.location)
                        );
                    }
                    
                    if (this.inventoryFilters.search) {
                        const search = this.inventoryFilters.search.toLowerCase();
                        filtered = filtered.filter(product => 
                            product.sku.toLowerCase().includes(search) ||
                            product.name.toLowerCase().includes(search) ||
                            product.serial_number.toLowerCase().includes(search) ||
                            product.label.toLowerCase().includes(search)
                        );
                    }
                    
                    this.filteredInventory = filtered;
                },

                refreshInventory() {
                    this.loadInventorySummary();
                    this.loadProducts();
                },

                searchInventory() {
                    // Aplicar filtros y mostrar resultados
                    this.filterInventory();
                },

                showAddProduct() {
                    // Esta función ya no se usa, se reemplazó por openModal() de JavaScript vanilla
                },

                closeAddProductModal() {
                    // Esta función ya no se usa, se reemplazó por closeModal() de JavaScript vanilla
                },

                editProduct(productOrId) {
                    let product = null;
                    
                    if (productOrId && typeof productOrId === 'object') {
                        product = productOrId;
                    } else {
                        const idToFind = productOrId ?? null;
                        product = this.products.find(p => p.id == idToFind) 
                            || this.filteredProducts.find(p => p.id == idToFind) 
                            || this.filteredInventory.find(p => p.id == idToFind);
                    }
                    
                    if (!product) {
                        console.error('editProduct: producto no encontrado', productOrId);
                        alert('No se pudo cargar el producto para editar.');
                        return;
                    }
                    
                    openEditModalWithProduct(product);
                },

                updateProduct() {
                    if (!this.editingProduct) return;
                    
                    // Validar campos requeridos
                    if (!this.editingProduct.sku || !this.editingProduct.name || !this.editingProduct.serial_number) {
                        alert('Por favor completa todos los campos requeridos');
                        return;
                    }
                    
                    // Validar SKU único (excluyendo el producto actual)
                    if (this.products.some(p => p.id !== this.editingProduct.id && p.sku.toLowerCase() === this.editingProduct.sku.toLowerCase())) {
                        alert('El SKU ya existe. Por favor usa un SKU diferente.');
                        return;
                    }
                    
                    // Validar número de serial único (excluyendo el producto actual)
                    if (this.products.some(p => p.id !== this.editingProduct.id && p.serial_number.toLowerCase() === this.editingProduct.serial_number.toLowerCase())) {
                        alert('El número de serial ya existe. Por favor usa un serial diferente.');
                        return;
                    }
                    
                    // Actualizar fecha de modificación
                    this.editingProduct.updated_at = new Date().toISOString().slice(0, 19).replace('T', ' ');
                    
                    // Buscar y actualizar el producto en la lista
                    const index = this.products.findIndex(p => p.id === this.editingProduct.id);
                    if (index !== -1) {
                        this.products[index] = { ...this.editingProduct };
                    }
                    
                    // Actualizar en filteredProducts
                    const filteredIndex = this.filteredProducts.findIndex(p => p.id === this.editingProduct.id);
                    if (filteredIndex !== -1) {
                        this.filteredProducts[filteredIndex] = { ...this.editingProduct };
                    }
                    
                    // Actualizar en filteredInventory
                    const inventoryIndex = this.filteredInventory.findIndex(p => p.id === this.editingProduct.id);
                    if (inventoryIndex !== -1) {
                        this.filteredInventory[inventoryIndex] = { ...this.editingProduct };
                    }
                    
                    // Cerrar modal
                    this.showEditProductModal = false;
                    this.editingProduct = null;
                    
                // Mostrar mensaje de éxito más visible
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                successMessage.innerHTML = `
                    <strong>¡Éxito!</strong> Producto actualizado correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(successMessage);
                
                // Auto-remover después de 5 segundos
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.parentNode.removeChild(successMessage);
                    }
                }, 5000);
                    
                    // Recargar datos
                    this.loadInventorySummary();
                },

                cancelEdit() {
                    this.showEditProductModal = false;
                    this.editingProduct = null;
                },

                generateEditBarcode() {
                    // Generar código de barras inteligente para edición
                    let barcode = '';
                    
                    if (this.editingProduct.sku) {
                        // Usar SKU como base
                        const skuClean = this.editingProduct.sku.replace(/[^A-Z0-9]/g, '');
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${skuClean}-${timestamp}`;
                    } else if (this.editingProduct.name) {
                        // Usar primeras letras del nombre
                        const nameWords = this.editingProduct.name.split(' ');
                        const initials = nameWords.map(word => word.charAt(0).toUpperCase()).join('');
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${initials}-${timestamp}`;
                    } else {
                        // Generar código aleatorio
                        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const timestamp = Date.now().toString().slice(-4);
                        barcode = `INV-${random}-${timestamp}`;
                    }
                    
                    // Verificar que el código de barras sea único (excluyendo el producto actual)
                    let counter = 1;
                    let finalBarcode = barcode;
                    while (this.products.some(p => p.id !== this.editingProduct.id && p.barcode === finalBarcode)) {
                        finalBarcode = `${barcode}-${counter}`;
                        counter++;
                    }
                    
                    this.editingProduct.barcode = finalBarcode;
                },

                searchProducts() {
                    if (!this.searchQuery) {
                        this.filteredProducts = this.products;
                        return;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    this.filteredProducts = this.products.filter(product => 
                        product.name.toLowerCase().includes(query) ||
                        product.sku.toLowerCase().includes(query) ||
                        product.description.toLowerCase().includes(query)
                    );
                },

                filterProducts() {
                    console.log('filterProducts called with productFilter:', this.productFilter);
                    console.log('Total products:', this.products.length);
                    
                    let filtered = this.products;
                    
                    // Filtrar por tipo de producto
                    if (this.productFilter !== 'all') {
                        console.log('Filtering by type:', this.productFilter);
                        const beforeFilter = filtered.length;
                        filtered = filtered.filter(product => {
                            console.log('Product type:', product.type, 'Filter:', this.productFilter, 'Match:', product.type === this.productFilter);
                            return product.type === this.productFilter;
                        });
                        console.log('After type filter:', filtered.length, 'products (was', beforeFilter, ')');
                    }
                    
                    if (this.selectedCategory) {
                        filtered = filtered.filter(product => product.category_id == this.selectedCategory);
                    }
                    
                    if (this.selectedSupplier) {
                        filtered = filtered.filter(product => product.supplier_id == this.selectedSupplier);
                    }
                    
                    console.log('Final filtered products:', filtered.length);
                    this.filteredProducts = filtered;
                },

                refreshData() {
                    this.loadProducts();
                    this.loadInventorySummary();
                },

                getStockBadgeClass(stock, minStock) {
                    if (stock <= minStock) return 'bg-danger';
                    if (stock <= minStock * 2) return 'bg-warning';
                    return 'bg-success';
                },

                getStatusBadgeClass(stock, minStock) {
                    if (stock <= minStock) return 'bg-danger';
                    if (stock <= minStock * 2) return 'bg-warning';
                    return 'bg-success';
                },

                getStatusText(stock, minStock) {
                    if (stock <= minStock) return 'Stock Bajo';
                    if (stock <= minStock * 2) return 'Stock Medio';
                    return 'En Stock';
                },

                formatNumber(number) {
                    const num = parseFloat(number) || 0;
                    return new Intl.NumberFormat('es-MX').format(num);
                },

                viewProduct(product) {
                    console.log('View product:', product);
                    // Implementar modal de visualización
                },

                deleteProduct(productOrId) {
                    let targetProduct = null;
                    
                    if (productOrId && typeof productOrId === 'object') {
                        targetProduct = productOrId;
                    } else {
                        targetProduct = this.products.find(p => p.id == productOrId)
                            || this.filteredProducts.find(p => p.id == productOrId)
                            || this.filteredInventory.find(p => p.id == productOrId);
                    }
                    
                    const productId = targetProduct ? targetProduct.id : productOrId;
                    const productName = targetProduct ? targetProduct.name || 'este producto' : 'este producto';
                    
                    if (!productId) {
                        alert('No se pudo determinar el producto a eliminar.');
                        return;
                    }
                    
                    if (confirm(`¿Estás seguro de eliminar el producto "${productName}"?`)) {
                        window.deleteProduct(productId);
                    }
                },
                goToLogin() {
                    console.log('🔐 Redirigiendo al login...');
                    window.location.href = '/login.php';
                },
                navigateToPHP(path) {
                    // Verificar que el usuario esté autenticado y tenga permisos
                    if (!this.user || this.user.role === 'guest') {
                        alert('Debes iniciar sesión para acceder a esta página');
                        window.location.href = '/login.php';
                        return;
                    }
                    
                    // Navegar a la página PHP
                    window.location.href = '/' + path;
                },
                
                setView(view) {
                    this.currentView = view;
                    if (view === 'sports-calendar') {
                        // Generar fechas automáticamente cuando se accede al calendario
                        if (this.matchdays.length === 0) {
                            this.generateMatchdays();
                        }
                    }
                },
                
                // Sports Calendar Methods
                generateMatchdays() {
                    // Generar fechas automáticamente (7 fechas para 8 equipos)
                    const numTeams = this.teams.length;
                    const numMatchdays = numTeams - 1;
                    this.matchdays = [];
                    
                    for (let i = 0; i < numMatchdays; i++) {
                        const matches = [];
                        // Generar partidos para cada fecha usando algoritmo round-robin
                        for (let j = 0; j < numTeams / 2; j++) {
                            const home = (i + j) % (numTeams - 1);
                            const away = (numTeams - 1 - j + i) % (numTeams - 1);
                            const homeTeam = home === numTeams - 1 ? numTeams - 1 : home;
                            const awayTeam = away === numTeams - 1 ? numTeams - 1 : away;
                            
                            matches.push({
                                id: `match-${i}-${j}`,
                                homeTeam: this.teams[homeTeam],
                                awayTeam: this.teams[awayTeam],
                                homeScore: 0,
                                awayScore: 0,
                                matchday: i + 1
                            });
                        }
                        this.matchdays.push(matches);
                    }
                    
                    // Generar tabla de eliminación automáticamente
                    this.generateEliminationTable();
                    
                    // Cargar partidos de la primera fecha
                    if (this.matchdays.length > 0) {
                        this.loadMatchesForMatchday(1);
                    }
                },
                
                generateEliminationTable() {
                    // Generar tabla de eliminación basada en los equipos
                    this.eliminationTable = this.teams.map(team => ({
                        name: team,
                        played: 0,
                        wins: 0,
                        draws: 0,
                        losses: 0,
                        goalsFor: 0,
                        goalsAgainst: 0,
                        goalDiff: 0,
                        points: 0
                    }));
                    
                    // Calcular estadísticas basadas en resultados
                    this.matchdays.forEach(matchday => {
                        matchday.forEach(match => {
                            if (match.homeScore !== null && match.awayScore !== null && (match.homeScore > 0 || match.awayScore > 0)) {
                                const homeTeam = this.eliminationTable.find(t => t.name === match.homeTeam);
                                const awayTeam = this.eliminationTable.find(t => t.name === match.awayTeam);
                                
                                if (homeTeam && awayTeam) {
                                    homeTeam.played++;
                                    awayTeam.played++;
                                    homeTeam.goalsFor += match.homeScore;
                                    homeTeam.goalsAgainst += match.awayScore;
                                    awayTeam.goalsFor += match.awayScore;
                                    awayTeam.goalsAgainst += match.homeScore;
                                    
                                    if (match.homeScore > match.awayScore) {
                                        homeTeam.wins++;
                                        homeTeam.points += 3;
                                        awayTeam.losses++;
                                    } else if (match.homeScore < match.awayScore) {
                                        awayTeam.wins++;
                                        awayTeam.points += 3;
                                        homeTeam.losses++;
                                    } else {
                                        homeTeam.draws++;
                                        awayTeam.draws++;
                                        homeTeam.points += 1;
                                        awayTeam.points += 1;
                                    }
                                    
                                    homeTeam.goalDiff = homeTeam.goalsFor - homeTeam.goalsAgainst;
                                    awayTeam.goalDiff = awayTeam.goalsFor - awayTeam.goalsAgainst;
                                }
                            }
                        });
                    });
                    
                    // Ordenar por puntos, diferencia de goles, goles a favor
                    this.eliminationTable.sort((a, b) => {
                        if (b.points !== a.points) return b.points - a.points;
                        if (b.goalDiff !== a.goalDiff) return b.goalDiff - a.goalDiff;
                        return b.goalsFor - a.goalsFor;
                    });
                },
                
                loadMatchesForMatchday(matchdayNumber) {
                    this.currentMatchday = matchdayNumber;
                    if (this.matchdays && this.matchdays[matchdayNumber - 1]) {
                        this.currentMatches = this.matchdays[matchdayNumber - 1];
                    } else {
                        this.currentMatches = [];
                    }
                },
                
                updateTable() {
                    // Actualizar tabla de eliminación cuando se actualizan resultados
                    this.generateEliminationTable();
                },
                
                updateMatchResult(match) {
                    // Actualizar resultado del partido
                    this.generateEliminationTable();
                }
            }
        }).mount('#app');
        
        // Hacer la instancia de Vue disponible globalmente
        // En Vue 3, necesitamos acceder al componente raíz
        setTimeout(() => {
            const appElement = document.querySelector('#app');
            if (appElement && appElement._vnode && appElement._vnode.component) {
                window.app = appElement._vnode.component.ctx;
                console.log('Vue app montado correctamente en window.app');
            } else {
                console.warn('No se pudo acceder a la instancia de Vue - window.app puede no funcionar');
                // Fallback: usar el elemento directamente
                window.app = appElement;
            }
        }, 100);
        
        // CONTROL DE NAVEGACIÓN DEL NAVEGADOR (botones atrás/adelante)
        window.addEventListener('popstate', function(event) {
            console.log('Navegación del navegador detectada:', window.location.pathname);
            
            // Si el usuario está logueado y trata de ir al login, redirigir al dashboard
            if (window.location.pathname === '/login.php' && window.app && window.app.user && window.app.user.role !== 'guest') {
                console.log('Usuario logueado intentando ir al login - redirigiendo al dashboard');
                window.history.pushState(null, '', '/');
                return;
            }
            
            // Si el usuario no está logueado y trata de ir al dashboard, redirigir al login
            if (window.location.pathname === '/' && window.app && window.app.user && window.app.user.role === 'guest') {
                console.log('Usuario no logueado intentando ir al dashboard - redirigiendo al login');
                window.history.pushState(null, '', '/login.php');
                window.location.href = '/login.php';
                return;
            }
        });
        
        // Prevenir navegación directa al login si ya está logueado
        if (window.location.pathname === '/login.php') {
            // Verificar sesión antes de mostrar la página
            fetch('/auth/me')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.authenticated) {
                        console.log('Usuario ya logueado - redirigiendo al dashboard');
                        window.location.href = '/';
                    }
                })
                .catch(err => {
                    console.log('Error verificando sesión:', err);
                });
        }
    </script>

    <!-- JavaScript vanilla para el modal -->
    <script>
        function openModal() {
            console.log('openModal called');
            
            // Generar SKU único automáticamente
            const autoSKU = generateUniqueSKU();
            document.getElementById('productSku').value = autoSKU;
            
            // Auto-rellenar código de barras basado en el SKU generado
            document.getElementById('productBarcode').value = 'INV-' + autoSKU;
            
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                console.log('Modal opened with auto-generated SKU:', autoSKU);
            } else {
                console.error('Modal not found');
            }
        }

        function closeModal() {
            console.log('closeModal called');
            const modal = document.getElementById('addProductModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
                console.log('Modal closed');
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const addModal = document.getElementById('addProductModal');
            const editModal = document.getElementById('editProductModal');
            
            if (event.target === addModal) {
                closeModal();
            }
            if (event.target === editModal) {
                closeEditModal();
            }
        }

        function generateBarcode() {
            const sku = document.getElementById('productSku').value;
            const name = document.getElementById('productName').value;
            const barcodeField = document.getElementById('productBarcode');
            
            let barcode = '';
            if (sku) {
                barcode = 'INV-' + sku.toUpperCase();
            } else if (name) {
                barcode = 'INV-' + name.substring(0, 10).replace(/\s+/g, '-').toUpperCase();
            } else {
                barcode = 'INV-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            }
            
            barcodeField.value = barcode;
        }

        function generateUniqueSKU() {
            // Obtener productos existentes desde Vue.js data
            let existingProducts = [];
            try {
                // Intentar obtener productos desde la instancia de Vue global
                if (window.app && window.app.products) {
                    existingProducts = window.app.products.map(p => ({sku: p.sku}));
                }
            } catch (e) {
                console.log('No se pudo obtener productos de Vue, usando lista por defecto');
            }
            
            // Lista de respaldo con productos existentes conocidos
            const fallbackProducts = [
                {sku: 'RES-1K-001'},
                {sku: 'CAP-100U-001'},
                {sku: 'LED-RED-001'},
                {sku: 'CAB-USB-001'},
                {sku: 'RES-10K-001'}
            ];
            
            if (existingProducts.length === 0) {
                existingProducts = fallbackProducts;
            }
            
            let attempts = 0;
            let newSKU;
            
            do {
                // Generar SKU basado en timestamp y número aleatorio
                const timestamp = Date.now().toString().slice(-6);
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                newSKU = 'PRD-' + timestamp + '-' + randomNum;
                attempts++;
                
                // Si después de 10 intentos no encuentra uno único, usar timestamp completo
                if (attempts > 10) {
                    newSKU = 'PRD-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                    break;
                }
            } while (existingProducts.some(p => p.sku.toLowerCase() === newSKU.toLowerCase()));
            
            console.log('SKU generado:', newSKU, 'después de', attempts, 'intentos');
            return newSKU;
        }

        function autoFillFields() {
            const sku = document.getElementById('productSku').value.trim();
            
            // Solo auto-rellenar Código de Barras basado en SKU
            if (sku && !document.getElementById('productBarcode').value) {
                document.getElementById('productBarcode').value = 'INV-' + sku.toUpperCase();
            }
        }

        function saveProduct() {
            console.log('saveProduct called');
            
            // Recopilar datos del formulario
            const productData = {
                sku: document.getElementById('productSku').value,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                model: document.getElementById('productModel').value,
                description: document.getElementById('productDescription').value,
                category_id: parseInt(document.getElementById('productCategory').value) || 1,
                supplier_id: parseInt(document.getElementById('productSupplier').value) || 1,
                type: document.getElementById('productType').value,
                serial_number: document.getElementById('productSerial').value,
                department: document.getElementById('productDepartment').value,
                label: document.getElementById('productLabel').value,
                barcode: document.getElementById('productBarcode').value,
                cost: parseFloat(document.getElementById('productCost').value) || 0,
                price: parseFloat(document.getElementById('productPrice').value) || 0,
                stock_quantity: parseInt(document.getElementById('productStock').value) || 0,
                min_stock_level: parseInt(document.getElementById('productMinStock').value) || 0,
                max_stock_level: parseInt(document.getElementById('productMaxStock').value) || 0,
                expiration_date: document.getElementById('productExpiration').value || null,
                status: document.getElementById('productStatus').value || 'active'
            };
            
            console.log('Product data:', productData);
            
            // Validar campos requeridos
            if (!productData.sku || !productData.name || !productData.serial_number || !productData.label || !productData.type) {
                alert('Por favor completa todos los campos requeridos (SKU, Nombre, Serial, Marbete, Tipo)');
                return;
            }
            
            // Campos opcionales pueden quedar en blanco
            console.log('Creando producto con campos opcionales:', {
                department: productData.department,
                brand: productData.brand,
                model: productData.model,
                description: productData.description
            });
            
            // Validar campos únicos (simulación con datos existentes)
            const existingProducts = [
                {sku: 'RES-1K-001', serial_number: 'RES001-2024-001', label: 'RES-1K-001'},
                {sku: 'CAP-100U-001', serial_number: 'CAP001-2024-001', label: 'CAP-100U-001'},
                {sku: 'LED-RED-001', serial_number: 'LED001-2024-001', label: 'LED-RED-001'}
            ];
            
            // Verificar SKU único
            if (existingProducts.some(p => p.sku.toLowerCase() === productData.sku.toLowerCase())) {
                alert('El SKU ya existe. Por favor usa un SKU diferente.');
                return;
            }
            
            // Verificar Serial único
            if (existingProducts.some(p => p.serial_number.toLowerCase() === productData.serial_number.toLowerCase())) {
                alert('El número de serial ya existe. Por favor usa un serial diferente.');
                return;
            }
            
            // Verificar Marbete único
            if (existingProducts.some(p => p.label.toLowerCase() === productData.label.toLowerCase())) {
                alert('El marbete ya existe. Por favor usa un marbete diferente.');
                return;
            }
            
            // Enviar datos al servidor
            fetch('/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.text().then(text => {
                    console.log('Raw response:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', e);
                        console.error('Response text:', text);
                        throw new Error('El servidor no devolvió JSON válido: ' + text.substring(0, 100));
                    }
                });
            })
            .then(data => {
                console.log('Success:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito más visible
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto guardado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    closeModal();
                    clearForm();
                    
                    // Recargar productos en lugar de la página completa
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    }
                } else {
                    alert('Error del servidor: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar el producto: ' + error.message);
            });
        }

        function clearForm() {
            // Limpiar todos los campos del formulario excepto SKU (se genera automáticamente)
            document.getElementById('productName').value = '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productModel').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productSupplier').value = '';
            document.getElementById('productType').value = '';
            document.getElementById('productSerial').value = '';
            document.getElementById('productDepartment').value = '';
            document.getElementById('productLabel').value = '';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productMinStock').value = '';
            document.getElementById('productMaxStock').value = '';
            document.getElementById('productExpiration').value = '';
            document.getElementById('productStatus').value = 'active';
        }

        // Variables y utilidades globales para edición
        let currentEditProductId = null;

        function resolveProduct(productOrId) {
            if (!productOrId) {
                return null;
            }

            if (typeof productOrId === 'object') {
                return productOrId;
            }

            const id = parseInt(productOrId, 10);
            if (Number.isNaN(id)) {
                return null;
            }

            if (window.app && Array.isArray(window.app.products)) {
                const fromProducts = window.app.products.find(p => p.id == id);
                if (fromProducts) {
                    return fromProducts;
                }
            }

            if (window.app && Array.isArray(window.app.filteredProducts)) {
                const fromFiltered = window.app.filteredProducts.find(p => p.id == id);
                if (fromFiltered) {
                    return fromFiltered;
                }
            }

            if (window.app && Array.isArray(window.app.filteredInventory)) {
                const fromInventory = window.app.filteredInventory.find(p => p.id == id);
                if (fromInventory) {
                    return fromInventory;
                }
            }

            return null;
        }

        function openEditModalWithProduct(product) {
            if (!product) {
                return;
            }

            fillEditForm(product);
            const modalElement = document.getElementById('editProductModal');
            if (!modalElement) {
                console.error('openEditModalWithProduct: modal no encontrado');
                return;
            }

            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
            modalInstance.show();
        }

        function editProduct(productOrId) {
            const product = resolveProduct(productOrId);

            if (product) {
                openEditModalWithProduct(product);
                return;
            }

            console.log('Producto no encontrado en memoria, cargando desde servidor...');
            fetch('/products')
                .then(response => response.json())
                .then(data => {
                    if (data.success && Array.isArray(data.data)) {
                        const foundProduct = data.data.find(p => p.id == productOrId);
                        if (foundProduct) {
                            openEditModalWithProduct(foundProduct);
                        } else {
                            alert('Producto no encontrado');
                        }
                    } else {
                        alert('Error al cargar productos');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar productos');
                });
        }

        function ensureSelectValue(selectId, value) {
            const select = document.getElementById(selectId);
            if (!select) {
                return;
            }

            if (value === null || value === undefined || value === '') {
                select.value = '';
                return;
            }

            const exists = Array.from(select.options).some(option => option.value == value);
            if (!exists) {
                const newOption = new Option(value, value, true, true);
                select.add(newOption);
            } else {
                select.value = value;
            }
        }

        function fillEditForm(product) {
            currentEditProductId = product.id;

            const assignValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value ?? '';
                }
            };

            assignValue('editProductSku', product.sku);
            assignValue('editProductName', product.name);
            assignValue('editProductBrand', product.brand);
            assignValue('editProductModel', product.model);
            assignValue('editProductSerial', product.serial_number);
            assignValue('editProductLabel', product.label);
            assignValue('editProductPrice', product.price);
            assignValue('editProductStock', product.stock_quantity);
            assignValue('editProductDescription', product.description);
            assignValue('editProductBarcode', product.barcode);
            assignValue('editProductStatus', product.status || 'active');

            ensureSelectValue('editProductCategory', product.category_id ?? '1');
            ensureSelectValue('editProductSupplier', product.supplier_id ?? '1');
            ensureSelectValue('editProductType', product.type || 'computo');
            ensureSelectValue('editProductDepartment', product.department || '');
        }

        function closeEditModal() {
            console.log('closeEditModal called');
            const modalElement = document.getElementById('editProductModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement) || bootstrap.Modal.getOrCreateInstance(modalElement);
                modalInstance.hide();
            }
            currentEditProductId = null;
        }

        function updateProduct() {
            console.log('updateProduct called');
            
            if (!currentEditProductId) {
                alert('Error: No se ha seleccionado un producto para editar');
                return;
            }
            
            // Recopilar datos del formulario
            const getTrimmedValue = (id) => {
                const element = document.getElementById(id);
                return element && typeof element.value === 'string' ? element.value.trim() : '';
            };

            const productData = {
                id: currentEditProductId,
                name: getTrimmedValue('editProductName'),
                description: getTrimmedValue('editProductDescription'),
                brand: getTrimmedValue('editProductBrand'),
                model: getTrimmedValue('editProductModel'),
                price: parseFloat(getTrimmedValue('editProductPrice')) || 0,
                stock_quantity: parseInt(getTrimmedValue('editProductStock'), 10) || 0,
                category_id: getTrimmedValue('editProductCategory') || '1',
                supplier_id: getTrimmedValue('editProductSupplier') || '1',
                type: getTrimmedValue('editProductType') || 'computo',
                serial_number: getTrimmedValue('editProductSerial'),
                department: getTrimmedValue('editProductDepartment'),
                label: getTrimmedValue('editProductLabel'),
                barcode: getTrimmedValue('editProductBarcode'),
                status: getTrimmedValue('editProductStatus') || 'active'
            };
            
            console.log('Frontend updateProduct: Datos a enviar:', productData);
            console.log('Frontend updateProduct: Tipo seleccionado:', productData.type);
            console.log('Frontend updateProduct: Departamento seleccionado:', productData.department);
            
            // Validar campos requeridos
            const requiredFields = ['name', 'serial_number', 'label'];
            for (const field of requiredFields) {
                if (!productData[field]) {
                    alert(`El campo ${field} es obligatorio`);
                    return;
                }
            }
            
            console.log('Enviando datos de actualización:', productData);
            
            // Enviar solicitud PUT
            fetch('/products', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito más visible
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto actualizado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    closeEditModal();
                    // Recargar los productos usando window.app
                    if (window.app && window.app.loadProducts) {
                        console.log('Recargando productos después de actualizar...');
                        window.app.loadProducts();
                        // También recargar el resumen del inventario
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    } else {
                        console.log('window.app no disponible - esperando a que se inicialice...');
                        // Esperar un momento y luego intentar recargar
                        setTimeout(() => {
                            if (window.app && window.app.loadProducts) {
                                window.app.loadProducts();
                                if (window.app.loadInventorySummary) {
                                    window.app.loadInventorySummary();
                                }
                            } else {
                                console.error('No se pudo recargar los productos - window.app no disponible');
                            }
                        }, 1000);
                    }
                } else {
                    // Mostrar mensaje de error más visible
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                    errorMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    errorMessage.innerHTML = `
                        <strong>Error:</strong> ${data.error || 'Error desconocido'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(errorMessage);
                    
                    // Auto-remover después de 8 segundos
                    setTimeout(() => {
                        if (errorMessage.parentNode) {
                            errorMessage.parentNode.removeChild(errorMessage);
                        }
                    }, 8000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el producto: ' + error.message);
            });
        }

        function deleteProduct(productId) {
            console.log('deleteProduct called with ID:', productId);
            
            if (!confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.')) {
                return;
            }
            
            fetch('/products', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: productId })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Mostrar mensaje de éxito
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    successMessage.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    successMessage.innerHTML = `
                        <strong>¡Éxito!</strong> Producto eliminado correctamente.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(successMessage);
                    
                    // Auto-remover después de 5 segundos
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 5000);
                    
                    // Recargar los productos
                    if (window.app && window.app.loadProducts) {
                        window.app.loadProducts();
                        if (window.app.loadInventorySummary) {
                            window.app.loadInventorySummary();
                        }
                    }
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto: ' + error.message);
            });
        }

        function viewProduct(productId) {
            console.log('viewProduct called with ID:', productId);
            // Por ahora solo mostrar alerta, se puede implementar un modal de vista después
            alert('Función de vista de producto en desarrollo. ID: ' + productId);
        }
    </script>

    <!-- Modal de Editar Producto -->
    <div class="modal fade" id="editProductModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close" onclick="closeEditModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSku" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="editProductSku" readonly>
                                    <div class="form-text">(No editable)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductName" class="form-label">Nombre del Producto</label>
                                    <input type="text" class="form-control" id="editProductName">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductBrand" class="form-label">Marca</label>
                                    <input type="text" class="form-control" id="editProductBrand">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductModel" class="form-label">Modelo</label>
                                    <input type="text" class="form-control" id="editProductModel">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSerial" class="form-label">Número de Serial</label>
                                    <input type="text" class="form-control" id="editProductSerial">
                                    <div class="form-text">(De debe ser único)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductLabel" class="form-label">Marbete</label>
                                    <input type="text" class="form-control" id="editProductLabel">
                                    <div class="form-text">(Debe ser único)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductCategory" class="form-label">Categoría</label>
                                    <select class="form-select" id="editProductCategory">
                                        <option value="1">Electrónica</option>
                                        <option value="2">Iluminación</option>
                                        <option value="3">Resistores</option>
                                        <option value="4">Capacitores</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductSupplier" class="form-label">Proveedor</label>
                                    <select class="form-select" id="editProductSupplier">
                                        <option value="1">Mouser Electronics</option>
                                        <option value="2">Digi-Key</option>
                                        <option value="3">Arrow Electronics</option>
                                        <option value="4">Farnell</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductType" class="form-label">Tipo de Equipo</label>
                                    <select class="form-select" id="editProductType">
                                        <option value="">Seleccionar tipo</option>
                                        <option value="telecomunicacion">Equipo de telecomunicación</option>
                                        <option value="computo">Equipos de cómputo</option>
                                    </select>
                                    <div class="form-text">Selecciona el tipo de equipo</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductDepartment" class="form-label">Departamento</label>
                                    <select class="form-select" id="editProductDepartment">
                                        <option value="">Sin asignar</option>
                                        <option value="Telemática">Telemática</option>
                                        <option value="S1">S1</option>
                                        <option value="Protección">Protección</option>
                                        <option value="S3">S3</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductPrice" class="form-label">Precio</label>
                                    <input type="number" step="0.01" class="form-control" id="editProductPrice">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductStock" class="form-label">Cantidad en Stock</label>
                                    <input type="number" class="form-control" id="editProductStock">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Descripción</label>
                            <textarea class="form-control" id="editProductDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductBarcode" class="form-label">Código de Barras</label>
                                    <input type="text" class="form-control" id="editProductBarcode">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editProductStatus" class="form-label">Estado</label>
                                    <select class="form-select" id="editProductStatus">
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="maintenance">Mantenimiento</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Producto -->
    <div class="modal fade" id="addProductModal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>
                        Agregar Nuevo Producto
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <!-- Información Básica -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información Básica
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="productSku" required 
                                           placeholder="Se genera automáticamente" maxlength="20" readonly>
                                    <div class="form-text">Código único del producto (generado automáticamente)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-control" id="productName" required 
                                           placeholder="Ej: Resistor 1K Ohm 1/4W">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Marca *</label>
                                    <input type="text" class="form-control" id="productBrand" required 
                                           placeholder="Ej: Vishay">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Modelo *</label>
                                    <input type="text" class="form-control" id="productModel" required 
                                           placeholder="Ej: CRCW0805">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Descripción</label>
                                    <textarea class="form-control" id="productDescription" rows="3" 
                                              placeholder="Descripción detallada del producto"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Categoría *</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="1">Electrónica</option>
                                        <option value="2">Iluminación</option>
                                        <option value="3">Resistores</option>
                                        <option value="4">Capacitores</option>
                                        <option value="5">Cables</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Proveedor *</label>
                                    <select class="form-select" id="productSupplier" required>
                                        <option value="">Seleccionar proveedor</option>
                                        <option value="1">Mouser Electronics</option>
                                        <option value="2">Digi-Key Electronics</option>
                                        <option value="3">Farnell</option>
                                        <option value="4">RS Components</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Equipo *</label>
                                    <select class="form-select" id="productType" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="telecomunicacion">Equipo de telecomunicación</option>
                                        <option value="computo">Equipos de cómputo</option>
                                    </select>
                                    <div class="form-text">Selecciona el tipo de equipo que estás agregando</div>
                                </div>
                            </div>
                            
                            <!-- Información de Inventario -->
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-warehouse me-2"></i>
                                    Información de Inventario
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Número de Serial *</label>
                                    <input type="text" class="form-control" id="productSerial" required 
                                           placeholder="Ej: RES001-2025-001" maxlength="30">
                                    <div class="form-text">Número único de serie del producto (OBLIGATORIO)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Departamento *</label>
                                    <select class="form-select" id="productDepartment" required>
                                        <option value="">Seleccionar departamento</option>
                                        <option value="Telemática">Telemática</option>
                                        <option value="S1">S1</option>
                                        <option value="Protección">Protección</option>
                                        <option value="S3">S3</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Marbete/Etiqueta *</label>
                                    <input type="text" class="form-control" id="productLabel" required 
                                           placeholder="Ej: RES-1K-001" maxlength="20">
                                    <div class="form-text">Etiqueta física del producto (OBLIGATORIO)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Código de Barras</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="productBarcode" 
                                               placeholder="Se genera automáticamente">
                                        <button class="btn btn-outline-secondary" type="button" onclick="generateBarcode()">
                                            <i class="fas fa-barcode"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Código de barras para escaneo</div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Información Financiera -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    Información Financiera
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Precio de Costo *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="productCost" required 
                                               step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Precio de Venta *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="productPrice" required 
                                               step="0.01" min="0" placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-info mb-3">
                                    <i class="fas fa-boxes me-2"></i>
                                    Control de Stock
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Cantidad en Stock *</label>
                                    <input type="number" class="form-control" id="productStock" required 
                                           min="0" placeholder="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Mínimo *</label>
                                    <input type="number" class="form-control" id="productMinStock" required 
                                           min="0" placeholder="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Máximo</label>
                                    <input type="number" class="form-control" id="productMaxStock" 
                                           min="0" placeholder="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información Adicional -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Expiración</label>
                                    <input type="date" class="form-control" id="productExpiration">
                                    <div class="form-text">Opcional - Para productos perecederos</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estado</label>
                                    <select class="form-select" id="productStatus">
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="discontinued">Descontinuado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-1"></i>
                        Guardar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>

